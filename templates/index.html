<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>IOC Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Estilos propios -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">

  <style>
    .hint-box {
      font-size: .9rem;
      border: 1px dashed #ced4da;
      border-radius: .5rem;
      padding: .75rem;
      background: #f8f9fa;
      color: #212529;
    }
    .bg-dark .hint-box {
      border-color: #495057;
      background: #1f1f1f;
      color: #e9ecef;
    }

    .bg-dark ::placeholder { color: #adb5bd !important; opacity: 1; }
    .bg-dark .form-control, .bg-dark .form-select {
      background-color: #1f1f1f; color: #e9ecef; border-color: #495057;
    }
    .bg-dark .table { color: #e9ecef; }

    #toast-portal {
      position: fixed;
      bottom: 16px;
      right: 16px;
      z-index: 1060;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: min(90vw, 560px);
      width: max-content;
      pointer-events: none;
    }
    .toast {
      pointer-events: auto;
      border: none !important;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }

    #corner-logo {
      position: fixed;
      bottom: 16px;
      left: 16px;
      width: 96px;
      height: auto;
      opacity: .85;
      z-index: 1040;
    }
    @media (max-width: 576px) {
      #corner-logo { width: 68px; }
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <button class="btn btn-outline-secondary btn-sm" onclick="toggleTheme()">🌙 Modo Oscuro</button>
    <div class="d-flex align-items-center gap-2">
      <button class="btn btn-outline-primary btn-sm" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNotifs" aria-controls="offcanvasNotifs">
        🔔 Notificaciones
        <span id="notif-badge" class="badge text-bg-danger rounded-pill d-none">0</span>
      </button>
      <a href="/logout" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
  </div>

  <h2 class="mb-4 text-center">Gestor de IPs Maliciosas</h2>

  <div class="alert alert-info text-center">
    📊 Total de IPs activas: <strong>{{ total_ips }}</strong><br>
    ℹ️ Añadidas: Manual (<strong>{{ contador_manual }}</strong>) · CSV (<strong>{{ contador_csv }}</strong>)
  </div>

  {% for category, message in (messages or []) %}
    <div class="alert alert-{{ category }} mt-2">{{ message }}</div>
  {% endfor %}

  <form method="POST" enctype="multipart/form-data" class="mt-3">
    <div class="row g-3 mb-3">
      <div class="col-lg-5">
        <input type="text" class="form-control" name="ip"
               placeholder="IP, red CIDR (1.2.3.0/24), rango (1.2.3.4-1.2.3.20) o IP + máscara (1.2.3.0 255.255.255.0)">
      </div>
      <div class="col-lg-3">
        <select class="form-select" name="ttl">
          <option value="permanente" selected>Permanente</option>
          <option value="1">1 día</option>
          <option value="3">3 días</option>
          <option value="7">7 días</option>
        </select>
      </div>
      <div class="col-lg-2">
        <button type="submit" class="btn btn-success w-100">Añadir</button>
      </div>
      <div class="col-lg-2 d-grid gap-2">
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteAll">Eliminar todas</button>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-lg-5">
        <input type="file" class="form-control" name="file" accept=".txt,.csv">
      </div>
      <div class="col-lg-3">
        <select class="form-select" name="ttl">
          <option value="permanente" selected>Permanente</option>
          <option value="1">1 día</option>
          <option value="3">3 días</option>
          <option value="7">7 días</option>
        </select>
      </div>
      <div class="col-lg-2">
        <button type="submit" class="btn btn-primary w-100">Subir archivo</button>
      </div>
      <div class="col-lg-2">
        <a href="/static/plantilla.csv" class="btn btn-outline-secondary w-100" download>Descargar plantilla</a>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-lg-6">
        <button type="button" class="btn btn-outline-warning w-100" data-bs-toggle="modal" data-bs-target="#modalDeleteNet">
          Eliminar por patrón (CIDR / Rango / IP+Máscara / IP)
        </button>
      </div>
      <div class="col-lg-6">
        <div class="hint-box">
          <strong>Ejemplos válidos:</strong>
          <ul class="mb-0">
            <li><code>203.0.113.0/24</code> (CIDR)</li>
            <li><code>203.0.113.10-203.0.113.50</code> (rango)</li>
            <li><code>203.0.113.0 255.255.255.0</code> (IP + máscara)</li>
            <li><code>203.0.113.5</code> (IP suelta)</li>
          </ul>
        </div>
      </div>
    </div>

    {% if error %}
      <div class="alert alert-danger">{{ error }}</div>
    {% endif %}
  </form>

  <!-- Modal Confirmación Eliminar Todas -->
  <div class="modal fade" id="confirmDeleteAll" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="POST">
          <div class="modal-header">
            <h5 class="modal-title text-danger">¿Eliminar todas las IPs?</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            ¿Estás seguro de que deseas eliminar <strong>todas</strong> las IPs bloqueadas?<br>
            Esta acción <strong>no se puede deshacer</strong>.
          </div>
          <div class="modal-footer">
            <input type="hidden" name="delete-all" value="1">
            <button type="submit" class="btn btn-danger">Eliminar todas</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Tabla de IPs actuales -->
  <div class="table-responsive mb-5">
    <table class="table table-bordered table-hover">
      <thead class="table-dark">
        <tr>
          <th>Dirección IP</th>
          <th>Fecha</th>
          <th>TTL (días)</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody>
        {% for ip in ips %}
        <tr>
          <td>{{ ip.split('|')[0] }}</td>
          <td>{{ ip.split('|')[1] }}</td>
          <td>{{ ip.split('|')[2] }}</td>
          <td>
            <form method="POST" style="margin: 0;">
              <input type="hidden" name="delete_ip" value="{{ ip.split('|')[0] }}">
              <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- Modal Eliminar por patrón -->
  <div class="modal fade" id="modalDeleteNet" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="POST">
          <div class="modal-header">
            <h5 class="modal-title text-danger">Eliminar por patrón</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <label for="delete_net_input" class="form-label">Introduce el patrón de red:</label>
            <input type="text" class="form-control" name="delete_net_input" id="delete_net_input"
                   placeholder="Ej: 192.168.1.0/24, 203.0.113.10-203.0.113.50, etc.">
            <div class="mt-2" id="preview-delete-result"></div>
          </div>
          <div class="modal-footer">
            <input type="hidden" name="delete-net" value="1">
            <button type="submit" class="btn btn-warning">Eliminar coincidencias</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <!-- Logo fijo en la esquina inferior izquierda -->
  <img id="corner-logo" src="{{ url_for('static', filename='img/logo-dpb.svg') }}" alt="Logo DPB">

  <!-- Botón flotante de Notificaciones -->
  <button id="notif-fab" class="btn btn-primary" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNotifs" aria-controls="offcanvasNotifs">
    🔔
    <span id="notif-badge" class="badge text-bg-danger rounded-pill d-none">0</span>
  </button>

  <!-- Panel lateral de notificaciones -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifs" aria-labelledby="offcanvasNotifsLabel">
    <div class="offcanvas-header">
      <h5 id="offcanvasNotifsLabel">Notificaciones</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
    </div>
    <div class="offcanvas-body d-flex flex-column" style="gap:.75rem;">
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
        <select id="filterType" class="form-select form-select-sm" style="max-width:180px">
          <option value="">Todos los tipos</option>
          <option value="success">Altas correctas</option>
          <option value="warning">Eliminaciones</option>
          <option value="danger">Rechazadas/Errores</option>
          <option value="accion_no_permitida">Bloqueo global</option>
        </select>
        <input id="filterDate" type="date" class="form-control form-control-sm" style="max-width:180px">
        <button id="applyFilters" class="btn btn-outline-primary btn-sm">Aplicar</button>
        <button id="clearFilters" class="btn btn-outline-secondary btn-sm">Limpiar</button>
        <span class="ms-auto small text-muted" id="notifCountInfo"></span>
      </div>

      <!-- Lista de notificaciones -->
      <div id="notifList" class="d-flex flex-column" style="gap:.5rem;"></div>

      <!-- Paginación -->
      <nav class="mt-2">
        <ul id="notifPagination" class="pagination pagination-sm mb-0"></ul>
      </nav>
    </div>
  </div>

  <!-- Toasts abajo a la derecha -->
  <div id="toast-portal" aria-live="polite" aria-atomic="true"></div>
<script>
  // ---------- Modo Oscuro ----------
  function toggleTheme() {
    const body = document.body;
    const isDark = body.classList.toggle('bg-dark');
    body.classList.toggle('text-white', isDark);
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  }
  window.onload = () => {
    if (localStorage.getItem('theme') === 'dark') toggleTheme();
  };

  // ---------- Buscador de IP ----------
  document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('buscadorIp');
    const table = document.getElementById('tablaIps');
    input?.addEventListener('keyup', function () {
      const filtro = input.value.toLowerCase();
      const filas = table.getElementsByTagName('tr');
      for (let i = 1; i < filas.length; i++) {
        const ip = filas[i].getElementsByTagName('td')[0]?.textContent.toLowerCase() || '';
        filas[i].style.display = ip.includes(filtro) ? '' : 'none';
      }
    });
  });

  // ---------- Toasts ----------
  const serverMessages = [
    {% for category, message in (messages or []) %}
      {"category": "{{category}}", "message": {{ message|tojson }} }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  function escapeHtml(str) {
    return (str || '').replace(/[&<>"']/g, s => ({
      '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
    }[s]));
  }

  function mapToastColor(cat) {
    if (cat === 'success') return 'success';
    if (cat === 'warning') return 'warning';
    if (cat === 'danger' || cat === 'accion_no_permitida') return 'danger';
    return 'secondary';
  }

  function showToasts() {
    const toastPortal = document.getElementById('toast-portal');
    const recentMsgs = serverMessages.filter(m =>
      ["añadida", "eliminada", "rechazada", "rechazadas", "duplicada", "permite"].some(k =>
        (m.message || "").includes(k))
    );

    recentMsgs.forEach(m => {
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-bg-${mapToastColor(m.category)} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');
      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">${escapeHtml(m.message)}</div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;
      toastPortal.appendChild(toast);
      new bootstrap.Toast(toast, { delay: 5000 }).show();
    });
  }
  showToasts();

  // ---------- Vista previa de patrón ----------
  const deleteInput = document.getElementById('delete_net_input');
  const previewResult = document.getElementById('previewResult');

  if (deleteInput && previewResult) {
    deleteInput.addEventListener('input', () => {
      const pattern = deleteInput.value.trim();
      if (!pattern) {
        previewResult.textContent = "Escribe un patrón para ver cuántas IPs coinciden.";
        previewResult.className = 'text-muted';
        return;
      }

      fetch(`/preview-delete?pattern=${encodeURIComponent(pattern)}`)
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            previewResult.textContent = `❌ ${data.error}`;
            previewResult.className = 'text-danger';
          } else {
            previewResult.textContent = `Coinciden ${data.count} IP(s).`;
            previewResult.className = 'text-success';
          }
        })
        .catch(() => {
          previewResult.textContent = "❌ Error al consultar coincidencias.";
          previewResult.className = 'text-danger';
        });
    });
  }

  function confirmDeletePattern() {
    const val = deleteInput?.value.trim();
    return confirm(`Vas a eliminar todas las IPs que coincidan con:\n\n${val}\n\n¿Confirmas?`);
  }

  // ---------- Filtros de notificaciones ----------
  const notifList = document.getElementById('notifList');
  const notifPagination = document.getElementById('notifPagination');
  const notifBadge = document.getElementById('notif-badge');
  const notifInfo = document.getElementById('notifCountInfo');
  const PAGE_SIZE = 10;

  let currentPage = 1;
  let filterType = '';
  let filterDate = '';

  const notifData = serverMessages.map((m, i) => {
    let dt = null;
    const match = m.message.match(/^(\d{4}-\d{2}-\d{2})(?:\s+(\d{2}:\d{2}:\d{2}))?/);
    if (match) dt = new Date(`${match[1]}T${match[2] || '00:00:00'}`);
    return { id: i+1, category: m.category, message: m.message, date: dt };
  });

  function updateBadge() {
    const unread = notifData.length;
    notifBadge.textContent = unread;
    notifBadge.classList.toggle('d-none', unread === 0);
  }

  function applyFilters() {
    filterType = document.getElementById('filterType').value;
    filterDate = document.getElementById('filterDate').value;
    currentPage = 1;
    renderNotifList();
  }

  function clearFilters() {
    filterType = '';
    filterDate = '';
    document.getElementById('filterType').value = '';
    document.getElementById('filterDate').value = '';
    currentPage = 1;
    renderNotifList();
  }

  function renderNotifList() {
    const filtered = notifData.filter(n => {
      if (filterType && n.category !== filterType) return false;
      if (filterDate && n.date) {
        const d = n.date.toISOString().split('T')[0];
        return d === filterDate;
      }
      return true;
    });

    notifInfo.textContent = `Mostrando ${filtered.length} notificaciones`;
    notifList.innerHTML = '';

    const totalPages = Math.ceil(filtered.length / PAGE_SIZE);
    if (currentPage > totalPages) currentPage = totalPages || 1;

    const start = (currentPage - 1) * PAGE_SIZE;
    const pageData = filtered.slice(start, start + PAGE_SIZE);

    pageData.forEach(n => {
      const el = document.createElement('div');
      el.className = 'border rounded p-2 bg-white';
      el.innerHTML = `
        <div class="d-flex justify-content-between">
          <span class="badge bg-${mapToastColor(n.category)}">${n.category.toUpperCase()}</span>
          <small>${n.date?.toLocaleString() || ''}</small>
        </div>
        <div class="mt-1">${escapeHtml(n.message)}</div>
      `;
      notifList.appendChild(el);
    });

    notifPagination.innerHTML = '';
    for (let i = 1; i <= totalPages; i++) {
      const li = document.createElement('li');
      li.className = `page-item ${i === currentPage ? 'active' : ''}`;
      const a = document.createElement('a');
      a.className = 'page-link';
      a.href = '#';
      a.textContent = i;
      a.onclick = (e) => {
        e.preventDefault();
        currentPage = i;
        renderNotifList();
      };
      li.appendChild(a);
      notifPagination.appendChild(li);
    }
  }

  document.getElementById('applyFilters').onclick = applyFilters;
  document.getElementById('clearFilters').onclick = clearFilters;
  renderNotifList();
  updateBadge();
</script>

</body>
</html>
