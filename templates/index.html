<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>IOC Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Estilos propios -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">

  <style>
    /* ---------- UI refinements ---------- */

    /* Hints legibles tambi√©n en modo oscuro */
    .hint-box {
      font-size: .9rem;
      border: 1px dashed #ced4da;
      border-radius: .5rem;
      padding: .75rem;
      background: #f8f9fa;
      color: #212529;
    }
    .bg-dark .hint-box {
      border-color: #495057;
      background: #1f1f1f;
      color: #e9ecef;
    }

    /* Placeholders visibles en oscuro */
    .bg-dark ::placeholder { color: #adb5bd !important; opacity: 1; }
    .bg-dark .form-control, .bg-dark .form-select {
      background-color: #1f1f1f; color: #e9ecef; border-color: #495057;
    }
    .bg-dark .table { color: #e9ecef; }

    /* TOASTS: arriba a la derecha, bajo el bot√≥n de notificaciones */
    #toast-portal{
      position: fixed;
      top: 64px;        /* Ajusta si tu cabecera es m√°s alta/baja */
      right: 16px;
      left: auto;
      transform: none;
      z-index: 1060;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: min(90vw, 560px);
      pointer-events: none;     /* no bloquean la UI */
      align-items: flex-end;
    }
    .toast{
      pointer-events: auto;     /* permite cerrar */
      border: none !important;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
    }

    /* Bot√≥n Notificaciones (en cabecera) con burbuja */
    #notif-btn{ position:relative; }
    #notif-badge{ position:absolute; top:-6px; right:-8px; }

    /* Logo esquina (SIN TOCAR, abajo derecha) */
    #corner-logo{
      position:fixed; bottom:16px; right:16px; width:96px; height:auto; opacity:.85; z-index:1040;
    }
    @media (max-width:576px){ #corner-logo{ width:68px; } }
  </style>
</head>
<body class="bg-light">

<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <button class="btn btn-outline-secondary btn-sm" onclick="toggleTheme()">üåô Modo Oscuro</button>

    <div class="d-flex align-items-center gap-2">
      <!-- Bot√≥n Notificaciones (arriba derecha) -->
      <button id="notif-btn" class="btn btn-outline-primary btn-sm"
              type="button" data-bs-toggle="offcanvas"
              data-bs-target="#offcanvasNotifs" aria-controls="offcanvasNotifs">
        üîî Notificaciones
        <span id="notif-badge" class="badge text-bg-danger rounded-pill d-none">0</span>
      </button>

      <a href="/logout" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
  </div>

  <h2 class="mb-4 text-center">Gestor de IPs Maliciosas</h2>

  <div class="alert alert-info text-center">
    üìä Total de IPs activas: <strong>{{ total_ips }}</strong><br>
    ‚ÑπÔ∏è A√±adidas: Manual (<strong>{{ contador_manual }}</strong>) ¬∑ CSV (<strong>{{ contador_csv }}</strong>)
  </div>

  <!-- Solo errores graves si el backend los env√≠a en 'error' -->
  {% if error %}
    <div class="alert alert-danger mt-2">{{ error }}</div>
  {% endif %}

  <form method="POST" enctype="multipart/form-data" class="mt-3">
    <!-- Alta manual -->
    <div class="row g-3 mb-3">
      <div class="col-lg-5">
        <input type="text" class="form-control" name="ip"
               placeholder="IP, red CIDR (1.2.3.0/24), rango (1.2.3.4-1.2.3.20) o IP + m√°scara (1.2.3.0 255.255.255.0)">
      </div>
      <div class="col-lg-3">
        <select class="form-select" name="ttl">
          <option value="permanente" selected>Permanente</option>
          <option value="1">1 d√≠a</option>
          <option value="3">3 d√≠as</option>
          <option value="7">7 d√≠as</option>
        </select>
      </div>
      <div class="col-lg-2">
        <button type="submit" class="btn btn-success w-100">A√±adir</button>
      </div>
      <div class="col-lg-2 d-grid gap-2">
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#confirmDeleteAll">Eliminar todas</button>
      </div>
    </div>

    <!-- Subida CSV/TXT -->
    <div class="row g-3 mb-4">
      <div class="col-lg-5">
        <input type="file" class="form-control" name="file" accept=".txt,.csv">
      </div>
      <div class="col-lg-3">
        <select class="form-select" name="ttl">
          <option value="permanente" selected>Permanente</option>
          <option value="1">1 d√≠a</option>
          <option value="3">3 d√≠as</option>
          <option value="7">7 d√≠as</option>
        </select>
      </div>
      <div class="col-lg-2">
        <button type="submit" class="btn btn-primary w-100">Subir archivo</button>
      </div>
      <div class="col-lg-2">
        <a href="/static/plantilla.csv" class="btn btn-outline-secondary w-100" download>Descargar plantilla</a>
      </div>
    </div>

    <!-- Acciones avanzadas -->
    <div class="row g-3 mb-4">
      <div class="col-lg-6">
        <button type="button" class="btn btn-outline-warning w-100" data-bs-toggle="modal" data-bs-target="#modalDeleteNet">
          Eliminar por patr√≥n (CIDR / Rango / IP+M√°scara / IP)
        </button>
      </div>
      <div class="col-lg-6">
        <div class="hint-box">
          <strong>Ejemplos v√°lidos:</strong>
          <ul class="mb-0">
            <li><code>203.0.113.0/24</code> (CIDR)</li>
            <li><code>203.0.113.10-203.0.113.50</code> (rango)</li>
            <li><code>203.0.113.0 255.255.255.0</code> (IP + m√°scara)</li>
            <li><code>203.0.113.5</code> (IP suelta)</li>
          </ul>
        </div>
      </div>
    </div>
  </form>

  <!-- Modal Confirmaci√≥n Eliminar Todas -->
  <div class="modal fade" id="confirmDeleteAll" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="POST">
          <div class="modal-header">
            <h5 class="modal-title text-danger">¬øEliminar todas las IPs?</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            ¬øEst√°s seguro de que deseas eliminar <strong>todas</strong> las IPs bloqueadas?<br>
            Esta acci√≥n <strong>no se puede deshacer</strong>.
          </div>
          <div class="modal-footer">
            <input type="hidden" name="delete-all" value="1">
            <button type="submit" class="btn btn-danger">Eliminar todas</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Eliminar por Patr√≥n (con previsualizaci√≥n) -->
  <div class="modal fade" id="modalDeleteNet" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" class="modal-content" onsubmit="return confirmDeletePattern();">
        <div class="modal-header">
          <h5 class="modal-title">Eliminar por patr√≥n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <label for="delete_net_input" class="form-label">Introduce un patr√≥n:</label>
          <input type="text" class="form-control" id="delete_net_input" name="delete_net_input"
                 placeholder="Ej: 203.0.113.0/24 ¬∑ 203.0.113.10-203.0.113.50 ¬∑ 203.0.113.0 255.255.255.0 ¬∑ 203.0.113.5"
                 required>

          <!-- Resultado de previsualizaci√≥n -->
          <div id="previewResult" class="mt-2 small text-muted">
            Escribe un patr√≥n para ver cu√°ntas IPs coinciden.
          </div>

          <div class="hint-box mt-3">
            <strong>Se eliminar√°n todas las IPs que coincidan.</strong>
            <ul class="mb-0">
              <li>CIDR: <code>203.0.113.0/24</code></li>
              <li>Rango: <code>203.0.113.10-203.0.113.50</code></li>
              <li>IP + m√°scara: <code>203.0.113.0 255.255.255.0</code></li>
              <li>IP suelta: <code>203.0.113.5</code></li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <input type="hidden" name="delete-net" value="1">
          <button type="submit" class="btn btn-warning">Eliminar coincidencias</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <hr>
  <h4>IPs bloqueadas</h4>

  <!-- Buscador de IPs -->
  <div class="mb-3">
    <input type="text" id="buscadorIp" class="form-control" placeholder="Buscar IP...">
  </div>

  <table class="table table-striped" id="tablaIps">
    <thead>
      <tr>
        <th>IP</th>
        <th>Fecha</th>
        <th>TTL</th>
        <th>Acci√≥n</th>
      </tr>
    </thead>
    <tbody>
      {% for ip in ips %}
        {% set parts = ip.split('|') %}
        <tr>
          <td>{{ parts[0] }}</td>
          <td>{{ parts[1] }}</td>
          <td>{{ '‚àû' if parts[2] == '0' else parts[2] }}</td>
          <td>
            <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDelete{{ loop.index }}">Eliminar</button>

            <!-- Modal Confirmar eliminaci√≥n individual -->
            <div class="modal fade" id="confirmDelete{{ loop.index }}" tabindex="-1" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <form method="POST">
                    <div class="modal-header">
                      <h5 class="modal-title">Confirmar eliminaci√≥n</h5>
                      <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                      ¬øEliminar <strong>{{ parts[0] }}</strong>?
                    </div>
                    <div class="modal-footer">
                      <input type="hidden" name="delete_ip" value="{{ parts[0] }}">
                      <button type="submit" class="btn btn-danger">Eliminar</button>
                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    </div>
                  </form>
                </div>
              </div>
            </div>

          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="text-center mt-4">
    <p class="text-muted">Proyecto hecho por Darell P√©rez ¬∑ Todos los derechos reservados</p>
  </div>
</div>

<!-- Logo DPB fijo (abajo derecha, SIN TOCAR) -->
<img id="corner-logo" src="{{ url_for('static', filename='img/logo-dpb.svg') }}" alt="Logo DPB">

<!-- Offcanvas de Notificaciones -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifs" aria-labelledby="offcanvasNotifsLabel">
  <div class="offcanvas-header">
    <h5 id="offcanvasNotifsLabel">Notificaciones</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column" style="gap:.75rem;">
    <!-- Filtros -->
    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
      <select id="filterType" class="form-select form-select-sm" style="max-width:180px">
        <option value="">Todos los tipos</option>
        <option value="success">Altas correctas</option>
        <option value="warning">Eliminaciones</option>
        <option value="danger">Rechazadas/Errores</option>
        <option value="accion_no_permitida">Bloqueo global</option>
      </select>
      <input id="filterDate" type="date" class="form-control form-control-sm" style="max-width:180px">
      <button id="applyFilters" class="btn btn-outline-primary btn-sm">Aplicar</button>
      <button id="clearFilters" class="btn btn-outline-secondary btn-sm">Limpiar</button>
      <span class="ms-auto small text-muted" id="notifCountInfo"></span>
    </div>

    <!-- Lista -->
    <div id="notifList" class="d-flex flex-column" style="gap:.5rem;"></div>

    <!-- Paginaci√≥n (10 por p√°gina) -->
    <nav class="mt-2">
      <ul id="notifPagination" class="pagination pagination-sm mb-0"></ul>
    </nav>
  </div>
</div>

<!-- Portal de toasts -->
<div id="toast-portal" aria-live="polite" aria-atomic="true"></div>

<script>
  /* ----------------- Tema oscuro ----------------- */
  function toggleTheme() {
    const body = document.body;
    const isDark = body.classList.toggle('bg-dark');
    body.classList.toggle('text-white', isDark);
    document.querySelectorAll('.card, .form-control, .form-select, .table').forEach(e => {
      e.classList.toggle('bg-dark', isDark);
      e.classList.toggle('text-white', isDark);
    });
    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  }
  window.onload = () => {
    if (localStorage.getItem('theme') === 'dark') toggleTheme();
  };

  /* ----------------- Buscador tabla ----------------- */
  document.addEventListener('DOMContentLoaded', function () {
    const input = document.getElementById('buscadorIp');
    const table = document.getElementById('tablaIps');
    if (input && table) {
      input.addEventListener('keyup', function () {
        const filtro = input.value.toLowerCase();
        const filas = table.getElementsByTagName('tr');
        for (let i = 1; i < filas.length; i++) {
          const celdas = filas[i].getElementsByTagName('td');
          if (celdas.length > 0) {
            const ip = celdas[0].textContent.toLowerCase();
            filas[i].style.display = ip.includes(filtro) ? '' : 'none';
          }
        }
      });
    }
  });

  /* ----------------- Datos de notificaciones (inyectados) ----------------- */
  const serverMessages = [
    {% for category, message in (messages or []) %}
      {"category": "{{category}}", "message": {{ message|tojson }} }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];

  /* ----------------- TOAST: SOLO la √∫ltima acci√≥n de ESTA petici√≥n -----------------
     - Aparece bajo el bot√≥n (arriba-dcha)
     - 10s para success/warning/danger; 20s para accion_no_permitida
     - Ignora el historial (mensajes que empiezan con fecha ISO)
  --------------------------------------------------------------------------- */
  (function showLatestActionToast(){
    const actionKeywords = [
      "a√±adida","a√±adidas","eliminada","eliminadas",
      "rechazada","rechazadas","Acci√≥n no permitida","IP duplicada",
      "IP rechazada","Nada que a√±adir"
    ];
    const isHistory = (txt) => /^\d{4}-\d{2}-\d{2}/.test((txt||"").trim());

    const currentOnly = (serverMessages || []).filter(m => !isHistory(m.message||""));
    const actionable = currentOnly.filter(m =>
      actionKeywords.some(k => (m.message||"").includes(k))
    );
    if (!actionable.length) return;

    // Badge = cu√°ntas acciones ocurrieron en esta petici√≥n
    try {
      const b = document.getElementById('notif-badge');
      if (b) {
        b.textContent = actionable.length;
        b.classList.toggle('d-none', actionable.length <= 0);
      }
    } catch(e){}

    // Mostrar SOLO la √∫ltima acci√≥n
    const m = actionable[actionable.length - 1];

    const portal = document.getElementById('toast-portal');
    const el = document.createElement('div');
    el.className = 'toast align-items-center text-bg-' + mapToastColor(m.category) + ' border-0';
    el.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${escapeHtml(m.message || '')}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast" aria-label="Close"></button>
      </div>`;
    portal.appendChild(el);

    const delay = (m.category === 'accion_no_permitida') ? 20000 : 10000;
    new bootstrap.Toast(el, { autohide: true, delay }).show();
  })();

  /* ----------------- Offcanvas: filtros + paginaci√≥n ----------------- */
  const PAGE_SIZE = 10;
  let notifData = (serverMessages || []).map((m, i) => {
    let dt = null, txt = m.message || '';
    const mdt = txt.match(/^(\d{4}-\d{2}-\d{2})(?:\s+(\d{2}:\d{2}:\d{2}))?/);
    if (mdt) { dt = new Date((mdt[1] + (mdt[2] ? 'T' + mdt[2] : 'T00:00:00'))); }
    return { id: i+1, category: m.category, message: txt, date: dt };
  });

  const listEl = document.getElementById('notifList');
  const pagEl = document.getElementById('notifPagination');
  const infoEl = document.getElementById('notifCountInfo');

  let filterType = '';
  let filterDate = '';
  let currentPage = 1;

  document.getElementById('applyFilters').addEventListener('click', () => {
    filterType = document.getElementById('filterType').value;
    filterDate = document.getElementById('filterDate').value;
    currentPage = 1;
    renderList();
  });
  document.getElementById('clearFilters').addEventListener('click', () => {
    document.getElementById('filterType').value = '';
    document.getElementById('filterDate').value = '';
    filterType = filterDate = '';
    currentPage = 1;
    renderList();
  });

  function filtered() {
    return notifData.filter(n => {
      if (filterType && n.category !== filterType) return false;
      if (filterDate) {
        const d = n.date;
        if (!d) return false;
        const ymd = d.toISOString().slice(0,10);
        if (ymd !== filterDate) return false;
      }
      return true;
    });
  }

  function renderList() {
    const data = filtered();
    const totalPages = Math.max(1, Math.ceil(data.length / PAGE_SIZE));
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * PAGE_SIZE;
    const pageItems = data.slice(start, start + PAGE_SIZE);

    infoEl.textContent = `Mostrando ${pageItems.length} de ${data.length} notificaciones`;

    listEl.innerHTML = '';
    pageItems.forEach(n => {
      const cls = mapToastColor(n.category);
      const pill = n.category === 'success' ? '‚úÖ' :
                   n.category === 'warning' ? '‚ö†Ô∏è' :
                   (n.category === 'danger' || n.category === 'accion_no_permitida') ? '‚ùå' : '‚ÑπÔ∏è';
      const dtTxt = n.date ? n.date.toLocaleString() : '';
      const item = document.createElement('div');
      item.className = `border rounded p-2 bg-white`;
      item.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
          <span class="badge text-bg-${cls}">${pill}</span>
          <span class="small text-muted ms-2">${escapeHtml(dtTxt)}</span>
        </div>
        <div class="mt-1">${escapeHtml(n.message)}</div>
      `;
      listEl.appendChild(item);
    });

    pagEl.innerHTML = '';
    const mkPage = (p, label = p, disabled = false, active = false) => {
      const li = document.createElement('li');
      li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
      const a = document.createElement('a');
      a.className = 'page-link';
      a.href = '#';
      a.textContent = label;
      a.addEventListener('click', (e) => {
        e.preventDefault();
        if (!disabled && currentPage !== p) {
          currentPage = p;
          renderList();
        }
      });
      li.appendChild(a);
      return li;
    };
    const pages = Math.max(1, Math.ceil(data.length / PAGE_SIZE));
    pagEl.appendChild(mkPage(Math.max(1, currentPage-1), '¬´', currentPage === 1, false));
    for (let p = 1; p <= pages; p++) pagEl.appendChild(mkPage(p, String(p), false, p === currentPage));
    pagEl.appendChild(mkPage(Math.min(pages, currentPage+1), '¬ª', currentPage >= pages, false));
  }
  renderList();

  // Al abrir offcanvas, consideramos "le√≠das" las de esta petici√≥n (se oculta burbuja)
  const offcanvasEl = document.getElementById('offcanvasNotifs');
  if (offcanvasEl) {
    offcanvasEl.addEventListener('shown.bs.offcanvas', () => {
      const b = document.getElementById('notif-badge');
      if (b) b.classList.add('d-none');
    });
  }

  /* ---------- utils compartidas ---------- */
  function mapToastColor(cat) {
    if (cat === 'success') return 'success';
    if (cat === 'warning') return 'warning';
    if (cat === 'accion_no_permitida' || cat === 'danger') return 'danger';
    return 'secondary';
  }
  function escapeHtml(str) {
    return (str || '').replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function confirmDeletePattern() {
    const val = document.getElementById('delete_net_input').value.trim();
    return confirm(`Vas a eliminar todas las IPs que coincidan con:\n\n${val}\n\n¬øConfirmas?`);
  }
</script>

</body>
</html>