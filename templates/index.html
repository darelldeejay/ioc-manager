<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="utf-8">
  <title>IOC Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />


  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <!-- Google Font (Inter) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Arranque de tema: evita flash claro si el usuario guard√≥ "dark" -->
  <script>
    (function () {
      try {
        if (localStorage.getItem('theme') === 'dark') {
          var s = document.createElement('style');
          s.id = 'anti-flash-dark';
          s.innerHTML = 'html,body{background-color:#121212 !important;color:#e9ecef !important;}';
          document.head.appendChild(s);
          document.documentElement.setAttribute('data-theme', 'dark');
        } else {
          document.documentElement.setAttribute('data-theme', 'light');
        }
      } catch (e) { }
    })();
  </script>

  <!-- Bootstrap -->


  <!-- Estilos propios -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}?v=2">

  <!-- Favicon (Moved to bottom to override) -->
  <link rel="icon" href="{{ url_for('static', filename='img/logo-dpb.svg') }}?v=5">
  <link rel="shortcut icon" href="{{ url_for('static', filename='img/logo-dpb.svg') }}?v=5">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/logo-dpb.svg') }}?v=5">

</head>

<body class="bg-light">

  <header class="topbar">
    <div class="container-fluid py-2">
      <div class="d-flex justify-content-between align-items-center">
        <!-- Lado izquierdo: logo + m√©tricas -->
        <div class="d-flex flex-column flex-md-row align-items-md-center gap-3">
          <div class="d-flex align-items-center gap-2">
            <span class="fw-semibold text-white">
              <i class="bi bi-shield-fill-check me-2"></i>IOC Manager
            </span>
          </div>
          <div class="topbar-metrics d-none d-md-flex align-items-center gap-4 small">
            <div>
              <div class="text-uppercase opacity-75" style="font-size:0.65rem;">Total activo (uni√≥n)</div>
              <div class="fw-semibold" id="totalCount">{{ union_total or total_ips or 0 }}</div>
            </div>
            <div>
              <div class="text-uppercase opacity-75" style="font-size:0.65rem;">Manual</div>
              <div class="fw-semibold" id="manualCount">{{ contador_manual or 0 }}</div>
            </div>
            <div>
              <div class="text-uppercase opacity-75" style="font-size:0.65rem;">CSV</div>
              <div class="fw-semibold" id="csvCount">{{ contador_csv or 0 }}</div>
            </div>
            <div>
              <div class="text-uppercase opacity-75" style="font-size:0.65rem;">API</div>
              <div class="fw-semibold" id="apiCount">{{ contador_api or 0 }}</div>
            </div>
          </div>
        </div>

        <!-- Lado derecho TOPBAR -->
        <div class="d-flex align-items-center gap-2 ms-auto">

          <!-- BOT√ìN TEMA -->
          <!-- BOT√ìN USUARIOS -->
          {% if session.get('role', 'editor') == 'admin' or session.get('username') == 'admin' %}

          {% endif %}

          {% if session.get('role', 'editor') == 'admin' or session.get('username') == 'admin' %}
          <a href="{{ url_for('admin_settings_ui') }}"
            class="btn btn-outline-light btn-sm rounded-pill d-flex align-items-center gap-1 me-2">
            <i class="bi bi-gear-fill"></i>
            <span>Config</span>
          </a>
          {% endif %}

          <button class="btn btn-outline-light btn-sm rounded-pill d-flex align-items-center gap-1" type="button"
            onclick="toggleTheme()" id="themeToggleBtn">
            <i class="bi bi-moon-stars" id="themeToggleIcon"></i>
            <span id="themeToggleText">Oscuro</span>
          </button>

          <!-- NOTIFICACIONES -->
          <div class="btn-group">
            <button id="notif-btn" class="btn btn-outline-light btn-sm rounded-pill d-flex align-items-center gap-1"
              type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasNotifs"
              aria-controls="offcanvasNotifs">
              <i class="bi bi-bell"></i>
              <span>Notificaciones</span>
              <span id="notif-badge" class="badge text-bg-danger rounded-pill ms-1 d-none">0</span>
            </button>

            <button id="markReadBtn"
              class="btn btn-outline-light btn-sm rounded-pill d-flex align-items-center justify-content-center"
              title="Marcar como le√≠do (sin abrir)">
              <i class="bi bi-check2-circle"></i>
            </button>
          </div>



          <!-- DIAGNOSTICS (Salud) -->
          {% if session.get('role') in ['admin', 'editor'] %}
          <div class="btn-group gap-1">
            <button class="btn btn-outline-warning btn-sm rounded-pill d-flex align-items-center gap-1" type="button"
              id="runDiagnosticsBtn" onclick="runDiagnostics()" title="Autodiagn√≥stico">
              <i class="bi bi-heart-pulse"></i>
              <span class="d-none d-lg-inline">Salud</span>
            </button>
            <button
              class="btn btn-outline-secondary btn-sm rounded-pill d-flex align-items-center justify-content-center"
              type="button" onclick="showTestHistory()" title="Ver Historial de Pruebas">
              <i class="bi bi-journal-text"></i>
            </button>
          </div>
          {% endif %}



          <!-- LOGOUT -->
          <a href="/logout" class="btn btn-outline-light btn-sm rounded-pill d-flex align-items-center gap-1">
            <i class="bi bi-box-arrow-right"></i>
            <span>Logout</span>
          </a>

        </div>

      </div>
    </div>
  </header>

  <div class="container py-3">
    <div class="text-center mb-3">
      <h2 class="fw-bold mb-1">
        <span class="title-gestor">Gestor</span>
        <span class="title-ioc">IOC&nbsp;Manager</span>
      </h2>
      <div class="mx-auto" style="width:120px; height:3px; background:#0d6efd; border-radius:2px;"></div>
      <p class="text-muted mt-2">
        Herramienta de seguridad para la gesti√≥n de IOCs
      </p>
    </div>

    <!-- ======= MAINTENANCE BANNER ======= -->
    {% if maintenance_mode %}
    <div class="alert alert-warning border-warning d-flex align-items-center mb-4 shadow-sm">
      <i class="bi bi-cone-striped fs-3 me-3 text-warning"></i>
      <div>
        <strong class="text-dark">MODO MANTENIMIENTO ACTIVO</strong>
        <div class="small text-muted">Las modificaciones est√°n bloqueadas. Solo lectura.</div>
      </div>
      {% if user_role == 'admin' %}
      <div class="ms-auto">
        <button class="btn btn-warning btn-sm fw-bold" onclick="toggleMaintenance(false)">
          Desactivar
        </button>
      </div>
      {% endif %}
    </div>
    {% endif %}

    <!-- ======= RESUMEN AMPLIADO ======= -->

    <!-- NUEVAS TARJETAS DE RESUMEN -->
    <div class="row g-3 mb-4">
      <!-- Tarjeta total IPs activas -->
      <div class="col-12 col-md-6 col-lg-4 col-xl-4">
        <div class="card metric-card h-100 border-0">
          <div class="card-body d-flex flex-column">
            <h6 class="text-uppercase mb-3">IPs activas</h6>

            <div class="d-flex align-items-end justify-content-between">
              <div class="display-5 fw-bold text-dark">{{ total_ips or 0 }}</div>
              <div class="text-end">
                <!-- v4 -->
                <div class="d-flex align-items-center justify-content-end text-primary mb-1">
                  <i class="bi bi-hdd-network me-2"></i>
                  <span class="fw-bold">{{ ipv4_count }}</span>
                  <span class="small ms-1 opacity-75">v4</span>
                </div>
                <!-- v6 -->
                <div class="d-flex align-items-center justify-content-end text-info">
                  <i class="bi bi-globe me-2"></i>
                  <span class="fw-bold">{{ ipv6_count }}</span>
                  <span class="small ms-1 opacity-75">v6</span>
                </div>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress my-3" style="height: 6px;">
              <div class="progress-bar bg-primary" role="progressbar" style="width: {{ v4_percent }}%"></div>
              <div class="progress-bar bg-info" role="progressbar" style="width: {{ v6_percent }}%"></div>
            </div>

            <!-- Footer: Gr√°ficas -->
            <div class="mt-auto pt-2 border-top d-flex justify-content-between align-items-center">
              <small class="text-muted">An√°lisis detallado</small>
              <button type="button" class="btn btn-sm btn-link text-decoration-none p-0 fw-bold" id="btnShowGraphs">
                Ver Gr√°ficas <i class="bi bi-arrow-right-short"></i>
              </button>
            </div>
          </div>
        </div>
      </div>


      <!-- Toolbar: Buscador y Acciones -->
      <!-- Tarjeta IPs por origen -->
      <div class="col-12 col-md-6 col-lg-4 col-xl-4">
        <div class="card metric-card h-100 border-0">
          <div class="card-body d-flex flex-column">
            <h6 class="text-uppercase mb-3">Por origen</h6>

            <div class="flex-grow-1">
              <!-- Manual -->
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center text-primary">
                  <i class="bi bi-keyboard me-2"></i>
                  <span class="small fw-bold">Manual</span>
                </div>
                <div class="fw-bold">{{ contador_manual or 0 }}</div>
              </div>

              <!-- CSV -->
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div class="d-flex align-items-center text-info">
                  <i class="bi bi-file-earmark-spreadsheet me-2"></i>
                  <span class="small fw-bold">CSV</span>
                </div>
                <div class="fw-bold">{{ contador_csv or 0 }}</div>
              </div>

              <!-- API -->
              <div class="d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center text-warning">
                  <i class="bi bi-hdd-rack me-2"></i>
                  <span class="small fw-bold">API</span>
                </div>
                <div class="fw-bold">{{ contador_api or 0 }}</div>
              </div>
            </div>

            <!-- Progress Bar -->
            <div class="progress mt-3" style="height: 6px;">
              <div class="progress-bar bg-primary" role="progressbar" style="width: {{ man_percent }}%" title="Manual">
              </div>
              <div class="progress-bar bg-info" role="progressbar" style="width: {{ csv_percent }}%" title="CSV"></div>
              <div class="progress-bar bg-warning" role="progressbar" style="width: {{ api_percent }}%" title="API">
              </div>
            </div>

            <!-- Spacer to match height of neighbor card footer -->
            <div class="mt-auto pt-2 border-top d-flex justify-content-between align-items-center invisible"
              style="height: 31px;">
              <!-- Invisible filler to ensure same height as Active IPs card footer -->
              <small>Placeholder</small>
            </div>
          </div>
        </div>
      </div>
      <!-- Tarjeta IPs por tag -->
      <div class="col-12 col-md-6 col-lg-4 col-xl-4">
        <div class="card metric-card h-100 border-0">
          <div class="card-body d-flex flex-column">
            <h6 class="text-uppercase mb-3">Por tag</h6>
            <div class="flex-grow-1">
              {% if sorted_tags %}
              {% for tname, tcount in sorted_tags[:5] %}
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="badge rounded-pill {{ tag_color(tname) }} px-3">{{ tname }}</span>
                <span class="fw-bold">{{ tcount }}</span>
              </div>
              {% endfor %}

              {% set remaining = sorted_tags|length - 5 %}
              {% if remaining > 0 %}
              <div class="text-center mt-2 border-top pt-2">
                <small class="text-muted fw-bold">+ {{ remaining }} etiquetas m√°s...</small>
              </div>
              {% endif %}
              {% else %}
              <div class="text-muted small">Sin tags registrados</div>
              {% endif %}
            </div>

          </div>
        </div>
      </div>
      <!-- Tarjeta logs de sincronizaci√≥n (NUEVA) -->
      <div class="col-12 col-md-6 col-lg-6 col-xl-6">
        <div class="card metric-card h-100 border-0">
          <div class="card-body d-flex flex-column">
            <h6 class="text-uppercase mb-3">√öltimas Sincronizaciones</h6>

            <div class="flex-grow-1">
              {% if latest_sync_logs %}
              <div class="d-flex flex-column gap-2">
                {% for log in latest_sync_logs %}
                <div class="d-flex align-items-center justify-content-between border-bottom pb-1">
                  <!-- Time & Status -->
                  <div class="d-flex align-items-center gap-2">
                    {% if log.status_code == 200 or log.status_code == 304 %}
                    <i class="bi bi-check-circle-fill text-success"></i>
                    {% else %}
                    <i class="bi bi-x-circle-fill text-danger"></i>
                    {% endif %}

                    <div class="d-flex flex-column">
                      <!-- Truncate IP if IPv6 is too long -->
                      <span class="fw-bold text-dark d-flex align-items-center gap-2" style="font-family: monospace;"
                        title="{{ log.remote_ip }}">
                        {{ log.remote_ip|truncate(15, True, '..') }}
                        {% if log.details and log.details.ip_count %}
                        <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle"
                          style="font-size: 0.6rem;">
                          {{ log.details.ip_count }} IPs
                        </span>
                        {% endif %}
                      </span>
                      <span class="text-muted" style="font-size: 0.7rem;">
                        {{ log.ts[11:19] }} <!-- HH:MM:SS from ISO string -->
                      </span>
                    </div>
                  </div>

                  <!-- Agent info (Mini) -->
                  <div class="text-end opacity-75" style="max-width: 60px;">
                    {% if 'FortiGate' in log.user_agent %}
                    <i class="bi bi-bricks" title="FortiGate"></i>
                    {% elif 'curl' in log.user_agent %}
                    <i class="bi bi-terminal" title="curl"></i>
                    {% else %}
                    <i class="bi bi-globe" title="Browser/Other"></i>
                    {% endif %}
                  </div>
                </div>
                {% endfor %}
              </div>
              {% else %}
              <div class="text-center text-muted mt-4">
                <i class="bi bi-hourglass-split display-6 opacity-25"></i>
                <div class="small mt-2">Esperando tr√°fico...</div>
              </div>
              {% endif %}
            </div>

            <!-- Footer: Link to full logs (Future) -->
            <div class="mt-auto pt-2 border-top d-flex justify-content-center">
              <small class="text-muted fst-italic">Logs de acceso al feed</small>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-md-6 col-lg-6 col-xl-6">
        <div class="card metric-card h-100 border-0">
          <div class="card-body d-flex flex-column">
            <h6 class="text-uppercase mb-3">Backups</h6>

            <div class="flex-grow-1 d-flex flex-column justify-content-center align-items-center text-center">
              {% if last_backup_ts %}
              <i class="bi bi-cloud-check text-success display-4 mb-2"></i>
              <small class="text-muted d-block">√öltimo backup:</small>
              <span class="fw-bold text-dark">{{ last_backup_ts }}</span>
              {% else %}
              <i class="bi bi-cloud-slash text-secondary display-4 mb-2"></i>
              <small class="text-muted">No hay backups recientes.</small>
              {% endif %}
            </div>

            <!-- Footer: Actions -->
            <div class="mt-3">
              <!-- Generate Button -->
              <form method="POST" action="{{ url_for('backup_now') }}" class="mb-2 w-100">
                <button class="btn btn-success btn-sm w-100 fw-bold" type="submit">
                  <i class="bi bi-cloud-plus-fill me-1"></i> Generar Nuevo
                </button>
              </form>

              <div class="d-flex gap-2 mb-2">
                <a href="/backup/latest.zip" class="btn btn-outline-secondary btn-sm flex-fill"
                  title="Descargar √∫ltimo">
                  <i class="bi bi-download"></i> Descargar
                </a>
                <a href="{{ url_for('backup_list') }}" class="btn btn-outline-secondary btn-sm flex-fill"
                  title="Historial">
                  <i class="bi bi-clock-history"></i> Historial
                </a>
              </div>

              <button class="btn btn-sm btn-link text-decoration-none w-100 p-0 text-muted" style="font-size: 0.85rem;"
                data-bs-toggle="modal" data-bs-target="#modalRestore">
                <i class="bi bi-arrow-counterclockwise"></i> Restaurar copia
              </button>
            </div>

            {% if user_role == 'admin' %}
            <div class="form-check form-switch small mt-2">
              <input class="form-check-input" type="checkbox" id="maintenanceSwitch"
                onchange="toggleMaintenance(this.checked)" {{ 'checked' if maintenance_mode else '' }}>
              <label class="form-check-label" for="maintenanceSwitch">Mantenimiento</label>
            </div>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    <!-- ======= FIN RESUMEN AMPLIADO ======= -->

    <!-- Botones de backup -->
    <!-- Botones de backup (en tarjetas) -->

    <!-- Solo errores graves si el backend los env√≠a en 'error' -->
    {% if error %}
    <div class="alert alert-danger mt-2">{{ error }}</div>
    {% endif %}

    {% if user_role != 'view_only' %}

    <!-- Navegaci√≥n de pesta√±as -->
    <ul class="nav nav-pills mb-3" id="formsTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="tab-manual" data-bs-toggle="pill" data-bs-target="#pane-manual"
          type="button" role="tab" aria-controls="pane-manual" aria-selected="true">
          <i class="bi bi-plus-circle me-1"></i> Alta manual
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-csv" data-bs-toggle="pill" data-bs-target="#pane-csv" type="button" role="tab"
          aria-controls="pane-csv" aria-selected="false">
          <i class="bi bi-file-earmark-spreadsheet me-1"></i> Carga CSV/TXT
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="tab-delete" data-bs-toggle="pill" data-bs-target="#pane-delete" type="button"
          role="tab" aria-controls="pane-delete" aria-selected="false">
          <i class="bi bi-trash me-1"></i> Eliminaci√≥n por patr√≥n
        </button>
      </li>
    </ul>

    <div class="tab-content card card-body shadow-sm mb-1 border-primary" id="actionsTabContent">

      <!-- === PESTA√ëA MANUAL === -->
      <div class="tab-pane fade show active" id="pane-manual" role="tabpanel" aria-labelledby="tab-manual">
        <form id="addManualForm" method="POST" action="{{ url_for('index') }}" novalidate>
          <input type="hidden" name="source" value="web">
          <!-- Alta manual -->
          <div class="row g-3 mb-1 align-items-end">
            <!-- IP -->
            <div class="col-lg-4">
              <label for="ipInput" class="form-label small mb-1">IP (v4/v6) / Red / Rango</label>
              <input id="ipInput" type="text" class="form-control" name="ip" autocomplete="off"
                placeholder="Ej: 1.2.3.4 ¬∑ 2001:db8::1 ¬∑ 1.2.3.0/24">
              <div id="ipFeedback" class="invalid-feedback"></div>
            </div>

            <!-- Ticket -->
            <div class="col-lg-2">
              <label class="form-label small mb-1">Ticket # <span class="text-danger">*</span></label>
              <input type="text" class="form-control" name="ticket_number" placeholder="Ej: TKT-123" required>
            </div>

            <!-- TTL -->
            <div class="col-lg-2">
              <label class="form-label small mb-1">Duraci√≥n (TTL)</label>
              <select class="form-select" name="ttl_manual">
                <option value="permanente" selected>Permanente</option>
                <option value="1">1 d√≠a</option>
                <option value="3">3 d√≠as</option>
                <option value="7">7 d√≠as</option>
                <option value="30">30 d√≠as</option>
              </select>
            </div>

            <!-- Botones -->
            <div class="col-lg-4">
              <button type="button" class="btn btn-primary w-100"
                onclick="document.getElementById('addManualForm').submit();">
                <i class="bi bi-shield-plus me-1"></i> Bloquear IP
              </button>
            </div>
          </div>

          <!-- Tags Manuales (Checkboxes) -->
          <div class="row mt-2">
            <!-- Selector Din√°mico de Tags (Dropdown) -->
            <div class="col-12">
              <label class="form-label small mb-1 fw-bold">Tags Existentes</label>
              <div class="dropdown">
                <button id="tagsDropdownBtn"
                  class="btn btn-outline-secondary btn-sm dropdown-toggle w-100 text-start d-flex justify-content-between align-items-center"
                  type="button" data-bs-toggle="dropdown" aria-expanded="false">
                  {% set default_selected = [] %}
                  {% for t in known_tags %}
                  {% if t == 'Multicliente' %}
                  {% set _ = default_selected.append(t) %}
                  {% endif %}
                  {% endfor %}
                  <span id="tagsDropdownSpan" class="{% if default_selected %}fw-bold{% else %}text-muted{% endif %}">
                    {% if default_selected %}{{ default_selected|join(', ') }}{% else %}Seleccionar tags...{% endif %}
                  </span>
                </button>
                <ul class="dropdown-menu w-100 shadow p-0" style="max-height: 250px; overflow-y: auto;">
                  {% for t in known_tags %}
                  <li>
                    <label class="dropdown-item d-flex align-items-center gap-2 py-2 cursor-pointer"
                      onclick="event.stopPropagation()">
                      <input class="form-check-input m-0 tag-chk-manual" type="checkbox" name="tags_manual_cb"
                        value="{{ t }}" onclick="window.refreshTagsUI()" onchange="window.refreshTagsUI()" {% if
                        t=='Multicliente' %}checked{% endif %}>
                      <span>{{ t }}</span>
                    </label>
                  </li>
                  {% else %}
                  <li class="p-3 text-muted small text-center">No hay tags creados a√∫n.</li>
                  {% endfor %}
                </ul>
              </div>
            </div>
            <!-- Otros Tags -->
            <div class="mt-2">
              <label class="form-label small mb-1">Otros Tags (opcional)</label>
              <input type="text" class="form-control form-control-sm" name="tags_manual_text"
                placeholder="Ej: Malware, Phishing">
              <div class="form-text small">Separados por espacio o coma.</div>
            </div>
          </div>


          <!-- Ayuda de formatos -->
          <div class="row mb-3">
            <div class="col-12">
              Formatos admitidos: IP (v4/v6) ¬∑ CIDR ¬∑ rango ¬∑ IP + m√°scara (p. ej. 1.2.3.0 255.255.255.0)
            </div>
          </div>
        </form>
      </div>

      <!-- === PESTA√ëA CSV === -->
      <div class="tab-pane fade" id="pane-csv" role="tabpanel" aria-labelledby="tab-csv">
        <form id="uploadCsvForm" method="POST" enctype="multipart/form-data" action="{{ url_for('index') }}">
          <input type="hidden" name="source" value="web">
          <!-- Subida por CSV -->
          <div class="row g-3 mb-1 align-items-end">
            <!-- Archivo -->
            <div class="col-lg-3">
              <label class="form-label small mb-1">Seleccionar archivo</label>
              <input class="form-control" type="file" id="file" name="file" accept=".csv,.txt" required>
            </div>

            <!-- TTL global para CSV -->
            <div class="col-lg-2">
              <label class="form-label small mb-1">TTL para todas las filas</label>
              <select class="form-select" id="ttl_csv" name="ttl_csv">
                <option value="permanente" selected>Permanente</option>
                <option value="1">1 d√≠a</option>
                <option value="3">3 d√≠as</option>
                <option value="7">7 d√≠as</option>
                <option value="30">30 d√≠as</option>
              </select>
            </div>

            <!-- Tags CSV (Ayuda explicativa) -->
            <div class="col-lg-5">
              <div class="alert alert-light border small mb-0 p-2 lh-sm">
                <i class="bi bi-info-circle me-1"></i>
                Formato: <strong>IP;Tags;AlertID</strong>
                <br>Tags: <em>Multicliente, BPE, Test</em>
              </div>
            </div>

            <!-- Botones (a la derecha) -->
            <div class="col-lg-2">
              <label class="form-label small mb-1 d-none d-lg-block">&nbsp;</label>
              <div class="d-flex gap-2">
                <button id="uploadCsvBtn" type="submit" class="btn btn-primary w-100">Subir</button>
                <a href="{{ url_for('static', filename='plantilla.csv') }}" class="btn btn-secondary w-100"
                  title="Descargar plantilla" download>
                  <i class="bi bi-download"></i>
                </a>
              </div>
            </div>
          </div>

          <!-- Nota de ayuda -->
          <div class="row mb-3">
            <div class="col-12">
              <div class="form-text small">Solo archivos .csv o .txt con una IP (v4 o v6) por l√≠nea.</div>
            </div>
          </div>
        </form>
      </div>

      <!-- === PESTA√ëA DELETE === -->
      <div class="tab-pane fade" id="pane-delete" role="tabpanel" aria-labelledby="tab-delete">
        <!-- Acciones avanzadas (Botones que abren modales) -->
        <div class="row g-3 mb-4">
          <div class="col-lg-6">
            <button type="button" class="btn btn-outline-warning w-100" data-bs-toggle="modal"
              data-bs-target="#modalDeleteNet">
              Eliminar por patr√≥n (CIDR / Rango / IP+M√°scara / IP)
            </button>
          </div>
          <div class="col-lg-6">
            <div class="hint-box">
              <strong>Ejemplos v√°lidos:</strong>
              <ul class="mb-0">
                <li><code>203.0.113.0/24</code> o <code>2001:db8::/32</code> (CIDR)</li>
                <li><code>1.2.3.4-1.2.3.50</code> (rango)</li>
                <li><code>203.0.113.0 255.255.255.0</code> (IP + m√°scara)</li>
                <li><code>2001:db8::1</code> (IP suelta)</li>
              </ul>
            </div>
          </div>
        </div>
      </div>

    </div>
    {% else %}
    <div class="alert alert-info d-flex align-items-center mb-4 mt-3">
      <i class="bi bi-shield-lock me-2 fs-4"></i>
      <div>
        <strong>Modo Solo Lectura:</strong> No tienes permisos para a√±adir o eliminar IPs.
      </div>
    </div>
    {% endif %}



    <!-- Modal Confirmaci√≥n Eliminar Todas -->
    <div class="modal fade" id="confirmDeleteAll" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <form method="POST">
            <div class="modal-header">
              <h5 class="modal-title text-danger">¬øEliminar todas las IPs?</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body">
              ¬øEst√°s seguro de que deseas eliminar <strong>todas</strong> las IPs bloqueadas?<br>
              Esta acci√≥n se podr√° <strong>deshacer durante 10 minutos</strong>.
            </div>
            <div class="modal-footer">
              <input type="hidden" name="delete-all" value="1">
              <button type="submit" class="btn btn-danger">Eliminar todas</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Modal Eliminar por Patr√≥n (con previsualizaci√≥n) -->
    <div class="modal fade" id="modalDeleteNet" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form method="POST" enctype="multipart/form-data" class="modal-content"
          onsubmit="return confirmDeletePattern();">
          <div class="modal-header">
            <h5 class="modal-title">Eliminar por patr√≥n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <label for="delete_net_input" class="form-label">Introduce un patr√≥n (IPv4/IPv6):</label>
            <input type="text" class="form-control" id="delete_net_input" name="delete_net_input"
              placeholder="Ej: 203.0.113.0/24 ¬∑ 2001:db8::/32 ¬∑ 1.2.3.4-1.2.3.50" required>

            <!-- Resultado de previsualizaci√≥n -->
            <div id="previewResult" class="mt-2 small text-muted">
              Escribe un patr√≥n para ver cu√°ntas IPs coinciden.
            </div>

            <div class="hint-box mt-3">
              <strong>Se eliminar√°n todas las IPs que coincidan.</strong>
              <ul class="mb-0">
                <li>CIDR: <code>203.0.113.0/24</code> o <code>2001:db8::/32</code></li>
                <li>Rango: <code>1.2.3.4-1.2.3.50</code></li>
                <li>IP: <code>1.2.3.4</code> o <code>2001:db8::1</code></li>
              </ul>
            </div>
          </div>
          <div class="modal-footer">
            <input type="hidden" name="delete-net" value="1">
            <button type="submit" class="btn btn-warning">Eliminar coincidencias</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>


    <!-- Modal Editar TTL -->
    <div class="modal fade" id="modalEditTTL" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title fs-6">Editar TTL</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="mb-2">
              <strong>IP:</strong> <span id="editTTLIp" class="text-monospace"></span>
            </div>
            <label class="form-label small">Nuevo TTL</label>
            <select class="form-select form-select-sm" id="editTTLSelect">
              <option value="0">Permanente</option>
              <option value="1">1 d√≠a</option>
              <option value="3">3 d√≠as</option>
              <option value="7">7 d√≠as</option>
              <option value="30">30 d√≠as</option>
            </select>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary btn-sm" onclick="saveEditTTL()">Guardar</button>
            <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Restaurar Backup -->
    <div class="modal fade" id="modalRestore" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <form method="POST" action="{{ url_for('backup_restore_upload') }}" enctype="multipart/form-data"
          class="modal-content"
          onsubmit="return confirm('‚ö†Ô∏è PELIGRO: ESTA ACCI√ìN SOBRESCRIBIR√Å TODOS LOS DATOS ACTUALES.\n\nSe crear√° una copia de seguridad autom√°tica antes de restaurar.\n\n¬øEst√°s seguro de continuar?');">
          <div class="modal-header">
            <h5 class="modal-title text-primary"><i class="bi bi-upload me-2"></i>Restaurar Backup</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning small">
              <i class="bi bi-exclamation-triangle-fill me-1"></i>
              <strong>Atenci√≥n:</strong> Vas a importar una copia de seguridad.<br>
              Todos los datos actuales ser√°n reemplazados por los del archivo.
            </div>
            <div class="mb-3">
              <label for="backup_file" class="form-label">Archivo ZIP</label>
              <input type="file" class="form-control" name="backup_file" id="backup_file" accept=".zip" required>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Restaurar ahora</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Visualizar Historial -->
    <div class="modal fade" id="modalHistory" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Historial: <span id="histIpLabel" class="text-monospace text-primary"></span></h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0" style="font-size: 0.9rem;">
                <thead class="table-light">
                  <tr>
                    <th>Fecha</th>
                    <th>Usuario</th>
                    <th>Acci√≥n</th>
                    <th>Fuente</th>
                    <th>Tags</th>
                    <th>Nota</th>
                  </tr>
                </thead>
                <tbody id="histTableBody">
                  <!-- JS Populate -->
                </tbody>
              </table>
            </div>
            <div id="histLoading" class="text-center p-4">
              <div class="spinner-border text-primary" role="status"></div>
            </div>
            <div id="histEmpty" class="text-center p-4 d-none text-muted">
              Sin historial registrado.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <div class="constrained-section mt-2">
      <h4 class="section-title">IPs bloqueadas</h4>

      <!-- Controles server-side (progresivo; si falla JSON, queda fallback local) -->
      <div class="toolbar-grid mb-3" id="serverToolbar">
        <div>
          <label class="form-label small mb-1">Buscar IP</label>
          <input type="text" id="qInput" class="form-control" placeholder="Ej: 203.0.113.5">
        </div>
        <div>
          <label class="form-label small mb-1">Versi√≥n IP</label>
          <select id="ipVersionSelect" class="form-select">
            <option value="all" selected>Todas</option>
            <option value="v4">IPv4</option>
            <option value="v6">IPv6</option>
          </select>
        </div>
        <div>
          <label class="form-label small mb-1">Origen</label>
          <select id="originSelect" class="form-select">
            <option value="all">Todos</option>
            <option value="manual">Manual</option>
            <option value="csv">CSV</option>
            <option value="api">API</option>
          </select>
        </div>
        <div>
          <label class="form-label small mb-1">Tag</label>
          <select id="tagSelect" class="form-select">
            <option value="all">Todos</option>
            {% set pinned = ['Multicliente', 'BPE', 'Test'] %}
            <!-- Pinned tags first -->
            {% for p in pinned %}
            <option value="{{ p }}">{{ p }}</option>
            {% endfor %}
            <!-- Other tags dynamically -->
            {% for t in known_tags %}
            {% if t not in pinned %}
            <option value="{{ t }}">{{ t }}</option>
            {% endif %}
            {% endfor %}
          </select>
        </div>
        <div class="d-flex gap-2">
          <div>
            <label class="form-label small mb-1">Desde</label>
            <input type="date" id="dateFrom" class="form-control">
          </div>
          <div>
            <label class="form-label small mb-1">Hasta</label>
            <input type="date" id="dateTo" class="form-control">
          </div>
        </div>
        <div>
          <label class="form-label small mb-1">Ordenar por</label>
          <select id="sortSelect" class="form-select">
            <option value="fecha" selected>Fecha alta</option>
            <option value="ttl">TTL (expiraci√≥n)</option>
            <option value="ip">IP</option>
          </select>
        </div>
        <div>
          <label class="form-label small mb-1">Orden</label><br>
          <div class="btn-group">
            <button id="orderDesc" class="btn btn-outline-secondary btn-sm active" type="button"
              data-order="desc">Desc</button>
            <button id="orderAsc" class="btn btn-outline-secondary btn-sm" type="button" data-order="asc">Asc</button>
          </div>
        </div>
        <div>
          <label class="form-label small mb-1">Tama√±o p√°g.</label>
          <select id="pageSize" class="form-select">
            <option>10</option>
            <option>25</option>
            <option selected>50</option>
            <option>100</option>
          </select>
        </div>
        <div class="d-flex align-items-end gap-2">
          <button id="applyTableFilters" class="btn btn-outline-primary">Aplicar</button>
          <button id="clearTableFilters" class="btn btn-outline-secondary">Limpiar</button>
        </div>
      </div>

      <!-- Buscador local (fallback) -->
      <div class="mb-3 d-none" id="localSearchWrap">
        <input type="text" id="buscadorIp" class="form-control" placeholder="Buscar IP...">
      </div>

      <div class="bulkbar d-flex justify-content-between align-items-center mb-2 p-2">
        <div class="small text-muted">
          <span id="bulkSelectedCount">0</span> seleccionada(s)
        </div>
        <div class="d-flex gap-2">
          <button id="bulkDeleteBtn" class="btn btn-outline-danger btn-sm" disabled>
            üóëÔ∏è Eliminar seleccionadas
          </button>
          <button id="bulkTagsBtn" class="btn btn-outline-secondary btn-sm" disabled onclick="openManageTags()">
            <i class="bi bi-tags"></i> Gestionar Tags
          </button>
        </div>
      </div>

      <div class="table-responsive">
        <table class="table table-sm table-striped table-hover align-middle" id="tablaIps" style="font-size: 0.9rem;">
          <thead>
            <tr>
              <th scope="col" style="width: 40px;">
                <input type="checkbox" id="chkAll" title="Seleccionar todo">
              </th>
              <th scope="col" style="width: 180px;">IP</th>
              <th scope="col" style="width: 120px;">Fecha Alta</th>
              <th scope="col" style="width: 100px;">TTL</th>
              <th scope="col" style="min-width: 250px;">Tags</th>
              <th scope="col" style="min-width: 200px;">Alertas / Ticket</th>
              <th scope="col" style="width: 100px; text-align: right;">Acci√≥n</th>
            </tr>
          </thead>
          <tbody>
            {% if ips and ips|length > 0 %}
            {% for item in ips %}
            {% set parts = item.split('|') %}
            {% set ip_txt = parts[0].strip() %}
            {% set tags = (ip_tags.get(ip_txt, []) if ip_tags is defined and ip_tags else []) %}
            {% if ip_alerts is defined and ip_alerts %}
            {% set alerts = ip_alerts.get(ip_txt, []) %}
            {% else %}
            {% set alerts = [] %}
            {% endif %}
            <tr>
              <td>
                <input type="checkbox" class="row-chk" value="{{ ip_txt }}">
              </td>
              <td class="fw-bold text-monospace">{{ ip_txt }}</td>
              <td class="small">{{ parts[1] }}</td>
              <td class="small" style="cursor:pointer;" title="Click para editar TTL"
                onclick="openEditTTL('{{ ip_txt }}', {{ tags|tojson }})">
                {% if parts[2] == '0' %}
                ‚àû
                {% else %}
                {{ parts[2] }}
                {% set left = days_remaining(parts[1], parts[2]) %}
                {% if left is not none %}
                <br><small class="text-muted">({{ left }} d. rest.)</small>
                {% endif %}
                {% endif %}
                <i class="bi bi-pencil-square ms-1 text-muted" style="font-size: 0.75rem;"></i>
              </td>
              <td>
                {% if tags %}
                <div class="d-flex flex-wrap gap-1">
                  {% for t in tags %}
                  <span class="badge border"
                    style="background-color: {{ tag_color(t) }}; color:#fff; font-weight:normal;">
                    {{ t }}
                    {% if user_role != 'view_only' %}
                    <i class="bi bi-x-circle ms-1" style="cursor: pointer; opacity: 0.8;"
                      onclick="removeTag(this, '{{ ip_txt }}', '{{ t }}'); event.stopPropagation();"
                      title="Quitar tag"></i>
                    {% endif %}
                  </span>
                  {% endfor %}
                </div>
                {% else %}
                <span class="text-muted small">‚Äî</span>
                {% endif %}
              </td>
              <td>
                {# --- Ticket / Alert ID (API) --- #}
                {% set tickets = ip_ticket_ids.get(ip_txt, []) if ip_ticket_ids is defined else [] %}
                <div class="d-flex flex-wrap gap-1 align-items-center">
                  {% if tickets %}
                  {% for t in tickets %}
                  <span class="badge bg-secondary text-light border border-secondary fw-normal text-truncate"
                    style="max-width:150px;" title="{{ t }}">{{ t }}</span>
                  {% endfor %}
                  {% endif %}

                  {# --- Internal System Alerts --- #}
                  {% if alerts %}
                  <span class="badge text-bg-warning text-dark border border-warning" title="{{ alerts|join(', ') }}">
                    {{ alerts|length }} sist.
                  </span>
                  {% endif %}

                  {% if not tickets and not alerts %}
                  <span class="text-muted small">‚Äî</span>
                  {% endif %}
                </div>
              </td>
              <td style="text-align: right;">
                {% if user_role != 'view_only' %}
                <div class="btn-group">
                  <button class="btn btn-sm btn-outline-info" onclick="showHistory('{{ ip_txt }}')"
                    title="Ver Historial">
                    <i class="bi bi-clock-history"></i>
                  </button>
                  <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal"
                    data-bs-target="#confirmDelete{{ loop.index }}" title="Eliminar">
                    <i class="bi bi-trash"></i>
                  </button>
                </div>
                <!-- Modal Delete specific -->
                <div class="modal fade" id="confirmDelete{{ loop.index }}" tabindex="-1" aria-hidden="true">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <form method="POST">
                        <div class="modal-header">
                          <h5 class="modal-title">Confirmar eliminaci√≥n</h5>
                          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                        </div>
                        <div class="modal-body">
                          {% if 'BPE' in tags or 'bpe' in tags %}
                          <div class="alert alert-warning border-warning">
                            <div class="d-flex">
                              <i class="bi bi-exclamation-triangle-fill fs-4 me-3"></i>
                              <div>
                                <strong>¬°Atenci√≥n: IP Cr√≠tica (BPE)!</strong><br>
                                Esta IP pertenece a la lista BPE. Se eliminar√° de <strong>ambas</strong> listas
                                (Principal
                                y BPE).
                              </div>
                            </div>
                          </div>
                          ¬øConfirmas eliminar <strong>{{ ip_txt }}</strong>?
                          {% else %}
                          ¬øEliminar <strong>{{ ip_txt }}</strong>?
                          {% endif %}
                        </div>
                        <div class="modal-footer">
                          <input type="hidden" name="delete_ip" value="{{ ip_txt }}">
                          <button type="submit" class="btn btn-danger">Eliminar</button>
                          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
                {% else %}
                <span class="text-muted small">üîí</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
            {% else %}
            <tr>
              <td colspan="7" class="text-center text-muted">‚Äî</td>
            </tr>
            {% endif %}
          </tbody>
        </table>
      </div>

      <!-- Paginaci√≥n server-side -->
      <div class="d-flex align-items-center justify-content-between mt-2" id="pagerBar">
        <div class="small text-muted" id="pageInfo">P√°gina 1</div>
        <div class="btn-group">
          <button id="prevPage" class="btn btn-outline-secondary btn-sm">¬´</button>
          <button id="nextPage" class="btn btn-outline-secondary btn-sm">¬ª</button>
        </div>
      </div>

      <div class="text-center mt-4 mb-3">
        <p class="text-muted small">Proyecto hecho por Darell P√©rez ¬∑ Todos los derechos reservados ¬∑ <span
            class="badge bg-light text-dark border">v2025.12.21 Refactor</span></p>
      </div>
    </div>

    <!-- Logo DPB fijo (abajo derecha, SIN TOCAR) -->
    <img id="corner-logo" src="{{ url_for('static', filename='img/logo-dpb.svg') }}" alt="Logo DPB">

    <!-- Offcanvas de Notificaciones -->
    <div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifs" aria-labelledby="offcanvasNotifsLabel">
      <div class="offcanvas-header bg-primary text-white">
        <h5 class="offcanvas-title" id="offcanvasNotifsLabel">
          <i class="bi bi-bell-fill me-2"></i>Historial
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
      </div>
      <div class="offcanvas-body d-flex flex-column bg-light" style="gap:.5rem;">
        <!-- Filtros -->
        <div class="d-flex flex-wrap align-items-center gap-2 mb-2 p-2 bg-white border rounded shadow-sm">
          <select id="filterType" class="form-select form-select-sm" style="width:auto;">
            <option value="">Todos</option>
            <option value="success">√âxito</option>
            <option value="warning">Aviso</option>
            <option value="danger">Error</option>
            <option value="accion_no_permitida">Prohibido</option>
          </select>
          <input id="filterDate" type="date" class="form-control form-control-sm" style="width:auto;">
          <button id="applyFilters" class="btn btn-primary btn-sm px-2">
            <i class="bi bi-funnel"></i>
          </button>
          <button id="clearFilters" class="btn btn-outline-secondary btn-sm px-2" title="Limpiar">
            <i class="bi bi-x-lg"></i>
          </button>
          <div class="ms-auto small text-muted" id="notifCountInfo"></div>
        </div>

        <!-- Lista Scrollable -->
        <div id="notifList" class="flex-grow-1 overflow-auto pe-1" style="min-height:0;">
          <!-- Se llena con JS -->
        </div>

        <!-- Paginaci√≥n -->
        <nav class="mt-2 text-center">
          <ul id="notifPagination" class="pagination pagination-sm justify-content-center mb-0"></ul>
        </nav>
      </div>
    </div>

    <!-- Portal de toasts (Posicionado Arriba Derecha) -->
    <div id="toast-portal" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

    <script>

      /* ----------------- Gesti√≥n de tema claro/oscuro ----------------- */
      (function () {

        function applyTheme(theme) {
          const body = document.body;
          const isDark = (theme === 'dark');

          // Clases globales en el body
          body.classList.remove('bg-light', 'bg-dark', 'text-white');
          if (isDark) {
            body.classList.add('bg-dark', 'text-white');
          } else {
            body.classList.add('bg-light');
          }

          // Atributo global para CSS
          document.documentElement.setAttribute('data-theme', theme);

          // Tabla principal
          const tbl = document.getElementById('tablaIps');
          if (tbl) {
            tbl.classList.toggle('table-dark', isDark);
          }

          // Bot√≥n de notificaciones
          const notifBtn = document.getElementById('notif-btn');
          if (notifBtn) {
            notifBtn.classList.remove('btn-outline-primary', 'btn-outline-light');
            notifBtn.classList.add(isDark ? 'btn-outline-light' : 'btn-outline-primary');
          }

          // Bot√≥n de tema (icono + texto)
          const icon = document.getElementById('themeToggleIcon');
          const text = document.getElementById('themeToggleText');
          if (icon && text) {
            if (isDark) {
              icon.classList.remove('bi-moon-stars');
              icon.classList.add('bi-sun');
              text.textContent = 'Claro';
            } else {
              icon.classList.remove('bi-sun');
              icon.classList.add('bi-moon-stars');
              text.textContent = 'Oscuro';
            }
          }
        }

        // Funci√≥n global que llama el onclick del bot√≥n
        window.toggleTheme = function () {
          const current = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'light';
          const next = (current === 'dark') ? 'light' : 'dark';

          // Guardar preferencia
          try {
            localStorage.setItem('theme', next);
          } catch (e) { }

          // Si pasamos a claro, quitamos el estilo anti-flash
          const anti = document.getElementById('anti-flash-dark');
          if (next === 'light' && anti) {
            anti.remove();
          }

          applyTheme(next);
        };

        // Aplicar tema guardado al cargar la p√°gina
        document.addEventListener('DOMContentLoaded', function () {
          let theme = 'light';
          try {
            const saved = localStorage.getItem('theme');
            if (saved === 'dark') theme = 'dark';
          } catch (e) { }
          applyTheme(theme);
        });

      })();
      /* ----------------- Estado de tabla (server-side) ----------------- */
      const state = {
        page: 1,
        page_size: 50,
        sort: 'fecha',
        order: 'desc',
        q: '',
        date_from: '',
        date_to: ''
      };

    </script>

    <!-- Modal Gesti√≥n de Usuarios -->
    <div class="modal fade" id="modalUsers" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Gesti√≥n de Usuarios</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <!-- Columna Lista -->
              <div class="col-md-7 border-end">
                <h6>Usuarios Activos</h6>
                <div class="table-responsive">
                  <table class="table table-sm table-hover" id="usersTable">
                    <thead>
                      <tr>
                        <th>Usuario</th>
                        <th>Rol</th>
                        <th>Creado</th>
                        <th>Acciones</th>
                      </tr>
                    </thead>
                    <tbody>
                      <!-- JS carga aqu√≠ -->
                    </tbody>
                  </table>
                </div>
              </div>
              <!-- Columna Crear -->
              <div class="col-md-5">
                <h6>Crear Nuevo Usuario</h6>
                <form id="formAddUser" class="mt-3">
                  <div class="mb-3">
                    <label class="form-label">Usuario</label>
                    <input type="text" name="username" class="form-control" required autocomplete="off">
                  </div>
                  <div class="mb-3">
                    <label class="form-label">Contrase√±a</label>
                    <input type="password" name="password" class="form-control" required autocomplete="new-password">
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Rol</label>
                    <select name="role" class="form-select">
                      <option value="view_only">Solo Lectura</option>
                      <option value="editor">Editor</option>
                      <option value="admin">Administrador</option>
                    </select>
                  </div>

                  <div class="mb-3">
                    <label class="form-label">Feeds Permitidos</label>
                    <div class="border p-2 rounded" style="max-height: 150px; overflow-y: auto;">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="allowed_feeds" value="*" id="feed_all">
                        <label class="form-check-label" for="feed_all">Todos (*)</label>
                      </div>
                      <!-- Feeds Din√°micos -->
                      {% for key, cfg in feeds_config.items() if key != 'global' %}
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="allowed_feeds" value="{{ key }}"
                          id="feed_{{ key }}">
                        <label class="form-check-label" for="feed_{{ key }}">
                          <i class="{{ cfg.icon }} me-1"></i> {{ cfg.label }}
                        </label>
                      </div>
                      {% endfor %}
                    </div>
                    <small class="text-muted">Si seleccionas *, tiene acceso a todo.</small>
                  </div>

                  <button type="submit" class="btn btn-primary w-100">Crear Usuario</button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Inyectar usuario actual para JS
      window.currentUser = "{{ session.get('username') }}";

      /* ----------------- Datos de notificaciones (inyectados) ----------------- */
      /* ----------------- Datos de notificaciones (inyectados) ----------------- */
      // Prioridad: server_messages_list (que ahora contiene dicts). Fallback: []
      const serverMessages = {{ server_messages_list | tojson }};
      const newFlashes = {{ current_flashes_list | tojson }};

      console.log("DEBUG: injected serverMessages:", serverMessages);

      window.serverMessages = serverMessages || [];
      window.newFlashes = newFlashes || [];

    </script>

    <!-- Bootstrap Bundle (JS) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Scripts de la aplicaci√≥n -->
    <script>console.log("DEBUG: Attempting to load index.js");</script>
    <script src="{{ url_for('static', filename='js/index.js') }}?v=105" defer></script>
    <script src="{{ url_for('static', filename='js/users.js') }}" defer></script>







    <script>
      /* ========================================================
      Estado de tabla (server-side)
      ======================================================== */
      const USER_ROLE = "{{ user_role }}"; // injected by server
      const CURRENT_FEED_KEY = "{{ current_feed|default('global') }}".toLowerCase();

      // Sincronizar Dropdown de Tags con la Pesta√±a (Feed) activa para mantener consistencia
      (function syncFeedToTag() {
        // Mapeo de claves de feed (app.py) a valores del select (HTML)
        const map = {
          'multicliente': 'Multicliente',
          'bpe': 'BPE',
          'test': 'Test',
          'global': 'all'
        };
        const target = map[CURRENT_FEED_KEY] || 'all';
        const sel = document.getElementById('tagSelect');
        if (sel) {
          // Solo forzamos si el select existe y tiene esa opci√≥n
          if (sel.querySelector(`option[value="${target}"]`)) {
            sel.value = target;
          } else if (target === 'all') {
            sel.value = 'all';
          }
        }
      })();






      /* ========================================================
      Inline TTL Edit Logic
      ======================================================== */
      let currentEditIp = null;
      let currentEditTags = [];

      function openEditTTL(ip, tags) {
        currentEditIp = ip;
        currentEditTags = tags || [];
        document.getElementById('editTTLIp').textContent = ip;
        document.getElementById('editTTLSelect').value = "0";
        const modal = new bootstrap.Modal(document.getElementById('modalEditTTL'));
        modal.show();
      }

      async function saveEditTTL() {
        const ttlVal = document.getElementById('editTTLSelect').value;
        if (!currentEditIp) return;

        const payload = {
          origen: "web-edit",
          force: true,
          items: [{
            ip: currentEditIp,
            tags: currentEditTags,
            ttl: ttlVal,
            nota: "Updated via inline edit"
          }]
        };

        try {
          const r = await fetch('/api/bloquear-ip', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });
          const ans = await r.json();
          // Hide modal
          const modalEl = document.getElementById('modalEditTTL');
          const modal = bootstrap.Modal.getInstance(modalEl);
          modal.hide();

          if (r.ok && (ans.status === 'ok' || ans.status === 'partial_ok')) {
            reloadTable(false);
          } else {
            alert("Error al actualizar: " + (ans.error || JSON.stringify(ans)));
          }
        } catch (e) {
          alert("Error de red: " + e.message);
        }
      }

      (function initDeletePreview() {
        const input = document.getElementById('delete_net_input');
        const preview = document.getElementById('previewResult');
        if (!input || !preview) return;

        let lastController = null;

        input.addEventListener('input', () => {
          const val = input.value.trim();
          if (!val) {
            preview.textContent = "Escribe un patr√≥n para ver cu√°ntas IPs coinciden.";
            preview.className = 'mt-2 small text-muted';
            return;
          }

          // if (lastController) lastController.abort();
          // lastController = new AbortController();
          // NOTA: AbortController comentado si da problemas, pero recomendado

          const controller = new AbortController();
          lastController = controller;

          fetch(`/preview-delete?pattern=${encodeURIComponent(val)}`, { signal: controller.signal })
            .then(r => r.json())
            .then(data => {
              if (data.error) {
                preview.textContent = `‚ùå ${data.error}`;
                preview.className = 'mt-2 small text-danger';
              } else {
                preview.textContent = `Coinciden ${data.count} IP(s).`;
                preview.className = 'mt-2 small text-success';
              }
            })
            .catch(err => {
              if (err.name === 'AbortError') return;
              preview.textContent = "‚ùå Error al consultar coincidencias.";
              preview.className = 'mt-2 small text-danger';
            });
        });
      })();

      window.initInstantValidate = function () {
        console.log("DEBUG: initInstantValidate START");
        const input = document.getElementById('ipInput');
        const feedback = document.getElementById('ipFeedback');
        const form = document.getElementById('addManualForm');

        console.log("DEBUG: Elements found:", "Input:", !!input, "Feedback:", !!feedback, "Form:", !!form);

        if (!input || !feedback || !form) {
          console.error("DEBUG: CRITICAL - Missing elements for validation");
          return;
        }

        const OCTET = '(25[0-5]|2[0-4]\\d|1?\\d?\\d)';
        const ipv4Re = new RegExp(`^${OCTET}(\\.${OCTET}){3}$`);
        const ipv6Re = /^[0-9a-fA-F:]+$/; // Basic check, backend validates strictly
        const cidrRe = new RegExp(`^${OCTET}(\\.${OCTET}){3}\\/(?:[0-9]|[12][0-9]|3[0-2])$`);
        const rangeRe = new RegExp(`^${OCTET}(\\.${OCTET}){3}\\s*-\\s*${OCTET}(\\.${OCTET}){3}$`);
        const ipMaskRe = new RegExp(`^${OCTET}(\\.${OCTET}){3}\\s+${OCTET}(\\.${OCTET}){3}$`);

        const validMasks = new Set([
          '255.255.255.255', '255.255.255.254', '255.255.255.252', '255.255.255.248',
          '255.255.255.240', '255.255.255.224', '255.255.255.192', '255.255.255.128',
          '255.255.255.0', '255.255.254.0', '255.255.252.0', '255.255.248.0',
          '255.255.240.0', '255.255.224.0', '255.255.192.0', '255.255.128.0',
          '255.255.0.0', '255.254.0.0', '255.252.0.0', '255.248.0.0', '255.240.0.0',
          '255.224.0.0', '255.192.0.0', '255.128.0.0', '255.0.0.0',
          '254.0.0.0', '252.0.0.0', '248.0.0.0', '240.0.0.0', '224.0.0.0',
          '192.0.0.0', '128.0.0.0', '0.0.0.0'
        ]);

        function isForbiddenZero(val) {
          const v = val.trim();
          if (v === '0.0.0.0') return true;
          if (v.startsWith('0.0.0.0/')) return true;
          if (v.startsWith('0.0.0.0 ')) return true;
          if (/^\s*0\.0\.0\.0\s*-\s*/.test(v)) return true;
          return false;
        }

        function validate(val) {
          console.log("Validating:", val);
          if (!val || !val.trim()) {
            return { ok: false, msg: 'Introduce una IP, CIDR, rango o IP con m√°scara.' };
          }
          if (isForbiddenZero(val)) {
            return { ok: false, msg: 'Acci√≥n no permitida: bloqueo de absolutamente todo (0.0.0.0).' };
          }
          if (ipv4Re.test(val)) { return { ok: true }; }
          if (ipv6Re.test(val) && val.includes(':')) {
            console.log("IPv6 Match!");
            return { ok: true };
          }
          if (cidrRe.test(val)) { return { ok: true }; }
          if (rangeRe.test(val)) { return { ok: true }; }
          if (ipMaskRe.test(val)) {
            const mask = val.trim().split(/\s+/)[1];
            if (validMasks.has(mask)) return { ok: true };
            return { ok: false, msg: 'M√°scara inv√°lida. Usa m√°scara de red contigua (p.ej. 255.255.255.0).' };
          }
          return {
            ok: false, msg: 'Formato inv√°lido (IPv4/IPv6). Ejemplos: 1.2.3.4 ¬∑ 2001:db8::1'
          };
        }

        function setState(state) {
          if (state.ok) {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
            feedback.textContent = '';
          } else {
            input.classList.remove('is-valid');
            input.classList.add('is-invalid');
            feedback.textContent = state.msg || 'Formato inv√°lido';
          }
        }

        input.addEventListener('input', () => {
          const state = validate(input.value);
          if (!input.value.trim()) {
            input.classList.remove('is-valid', 'is-invalid');
            feedback.textContent = '';
            return;
          }
          setState(state);
        });

        form.addEventListener('submit', (e) => {
          if (input.value.trim()) {
            const state = validate(input.value);
            if (!state.ok) {
              e.preventDefault();
              e.stopPropagation();
              setState(state);
              input.focus();
            }
          }
        });
        // Init Notifications
        if (typeof window.initNotificationsSystem === 'function') {
          window.initNotificationsSystem();
        }
        function mapToastColor(cat) {
          if (cat === 'success') return 'success';
          if (cat === 'warning') return 'warning';
          if (cat === 'accion_no_permitida' || cat === 'danger') return 'danger';
          return 'secondary';
        }
        function escapeHtml(str) {
          return (str || '').replace(/[&<>"']/g, s => ({
            '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
          }[s]));
        }

        function confirmDeletePattern() {
          const val = document.getElementById('delete_net_input').value.trim();
          return confirm(`Vas a eliminar todas las IPs que coincidan con:\n\n${val}\n\n¬øConfirmas?`);
        }

        function markAllReadUI() {
          localStorage.setItem('notif_unread', '0');
          const badge = document.getElementById('notif-badge');
          if (badge) {
            badge.textContent = '0';
            badge.classList.add('d-none');
          }
        }

        function getSelectedIPs() {
          return Array.from(document.querySelectorAll('.row-chk:checked')).map(chk => chk.value);
        }

        function updateBulkUI() {
          const count = getSelectedIPs().length;
          const btn = document.getElementById('bulkDeleteBtn');
          const label = document.getElementById('bulkSelectedCount');
          if (label) label.textContent = String(count);
          if (btn) btn.disabled = (count === 0);
        }

        /* ========================================================
        Select All Logic
        ======================================================== */
        const selectAllCb = document.getElementById('chkAll');
        if (selectAllCb) {
          selectAllCb.checked = false; // Reset on load
          selectAllCb.addEventListener('change', function () {
            const isChecked = this.checked;
            document.querySelectorAll('.row-chk').forEach(chk => {
              chk.checked = isChecked;
              const tr = chk.closest('tr');
              if (tr) tr.classList.toggle('table-active-selected', isChecked);
            });
            updateBulkUI();
          });
        }

        function attachTableSelectionHandlers() {
          document.querySelectorAll('.row-chk').forEach(chk => {
            chk.addEventListener('change', function () {
              const tr = this.closest('tr');
              if (tr) tr.classList.toggle('table-active-selected', this.checked);

              // Sync master
              if (!this.checked && selectAllCb) selectAllCb.checked = false;
              if (this.checked && selectAllCb) {
                const all = document.querySelectorAll('.row-chk');
                const allChecked = Array.from(all).every(c => c.checked);
                selectAllCb.checked = allChecked;
              }

              updateBulkUI();
            });
          });
        }

        // Global UI Variables (so reloadTable can access them)
        let tbody, pageInfo, prevBtn, nextBtn;
        let qInput, originSelect, tagSelect, dateFrom, dateTo;
        let sortSelect, orderDesc, orderAsc, pageSizeSel;
        let applyBtn, clearBtn;

        // Utility: Debounce (Global or Local is fine, but Global allows reuse if needed)
        function debounce(func, wait) {
          let timeout;
          return function (...args) {
            clearTimeout(timeout);
            timeout = setTimeout(() => func.apply(this, args), wait);
          };
        }

        document.addEventListener('DOMContentLoaded', function () {
          console.log("DEBUG: Script Initializing...");

          // Assign Globals
          tbody = document.querySelector('#tablaIps tbody');
          pageInfo = document.getElementById('pageInfo');
          prevBtn = document.getElementById('prevPage');
          nextBtn = document.getElementById('nextPage');
          qInput = document.getElementById('qInput');
          originSelect = document.getElementById('originSelect');
          tagSelect = document.getElementById('tagSelect');
          dateFrom = document.getElementById('dateFrom');
          dateTo = document.getElementById('dateTo');
          sortSelect = document.getElementById('sortSelect');
          orderDesc = document.getElementById('orderDesc');
          orderAsc = document.getElementById('orderAsc');
          pageSizeSel = document.getElementById('pageSize');
          applyBtn = document.getElementById('applyTableFilters');
          clearBtn = document.getElementById('clearTableFilters');

          // Attach Listeners
          if (orderDesc) orderDesc.addEventListener('click', () => {
            tableState.order = 'desc';
            orderDesc.classList.add('active'); orderAsc.classList.remove('active'); reloadTable(true);
          });
          if (orderAsc) orderAsc.addEventListener('click', () => {
            tableState.order = 'asc';
            orderAsc.classList.add('active'); orderDesc.classList.remove('active'); reloadTable(true);
          });
          if (sortSelect) sortSelect.addEventListener('change', () => {
            tableState.sort = sortSelect.value;
            reloadTable(true);
          });
          if (pageSizeSel) pageSizeSel.addEventListener('change', () => {
            tableState.page_size =
              parseInt(pageSizeSel.value, 10) || 50; tableState.page = 1; reloadTable(true);
          });

          if (tagSelect) tagSelect.addEventListener('change', () => { tableState.page = 1; reloadTable(true); });
          if (originSelect) originSelect.addEventListener('change', () => { tableState.page = 1; reloadTable(true); });

          // Real-time search Listener
          if (qInput) {
            qInput.addEventListener('input', debounce(() => {
              tableState.q = qInput.value.trim();
              tableState.page = 1;
              reloadTable(true);
            }, 300));
          }

          if (applyBtn) applyBtn.addEventListener('click', () => {
            tableState.q = qInput ? qInput.value.trim() : '';
            tableState.date_from = dateFrom ? (dateFrom.value || '') : '';
            tableState.date_to = dateTo ? (dateTo.value || '') : '';
            tableState.page = 1;
            reloadTable(true);
          });

          if (clearBtn) clearBtn.addEventListener('click', () => {
            if (qInput) qInput.value = '';
            if (dateFrom) dateFrom.value = '';
            if (dateTo) dateTo.value = '';
            if (originSelect) originSelect.value = 'all';
            if (tagSelect) tagSelect.value = 'all';
            if (sortSelect) sortSelect.value = 'fecha';
            tableState.sort = 'fecha';
            tableState.order = 'desc';
            if (orderDesc) orderDesc.classList.add('active');
            if (orderAsc) orderAsc.classList.remove('active');
            if (pageSizeSel) pageSizeSel.value = '50';
            tableState.page_size = 50;
            tableState.page = 1;
            reloadTable(true);
          });

          if (prevBtn) prevBtn.addEventListener('click', () => {
            if (tableState.page > 1) {
              tableState.page--;
              reloadTable(false);
            }
          });
          if (nextBtn) nextBtn.addEventListener('click', () => { tableState.page++; reloadTable(false); });

        }); // End DOMContentLoaded

        async function reloadTable(resetIfEmpty) {
          try {
            const params = new URLSearchParams();
            params.set('format', 'json');
            params.set('page', String(tableState.page));
            params.set('page_size', String(tableState.page_size));
            params.set('sort', tableState.sort);
            params.set('order', tableState.order);
            // Nuevos filtros
            if (originSelect && originSelect.value && originSelect.value !== 'all') {
              params.set('origin', originSelect.value);
            }
            if (tagSelect && tagSelect.value && tagSelect.value !== 'all') params.set('tag', tagSelect.value);

            if (tableState.q) params.set('q', tableState.q);
            const hasRange = (tableState.date_from || tableState.date_to);
            if (hasRange) {
              const val = `${tableState.date_from || ''}${tableState.date_from || tableState.date_to ? ',' :
                ''}${tableState.date_to || ''}`;
              params.set('date', val);
            }
            const r = await fetch(`/?${params.toString()}`, { headers: { 'Accept': 'application/json' } });
            if (!r.ok) throw new Error('HTTP ' + r.status);
            const data = await r.json();
            renderRows(data.items || []);
            updateCounters(data.counters);
            updatePager(data.page, data.page_size, data.total);
            serverMode = true;
            document.getElementById('localSearchWrap').classList.add('d-none');
          } catch (e) {
            serverMode = false;
            initLocalSearchFallback();
          }
        }

        function tagBadge(t) {
          // Colores consistentes con Backend
          let cls = 'text-bg-info text-dark'; // Default: Cyan
          const tl = (t || '').toLowerCase();

          if (tl.includes('multicliente')) cls = 'text-bg-primary';
          else if (tl.includes('bpe')) cls = 'text-bg-warning text-dark';
          else if (tl.includes('test')) cls = 'text-bg-secondary';

          return `<span class="badge ${cls}" style="margin-right:4px;">${escapeHtml(t)}</span>`;
        }

        function alertsCellHtml(row) {
          const ids = row.alert_ids || [];
          if (!ids.length) {
            return '<span class="text-muted">‚Äî</span>';
          }
          const count = ids.length;
          const listPreview = ids.slice(0, 6).map(escapeHtml).join(', ');
          const more = ids.length > 6 ? ' ‚Ä¶' : '';
          const plural = count === 1 ? '' : 's';
          return `
        <span class="badge text-bg-info">${count} alerta${plural}</span>
        <div class="alert-ids-list text-muted">${listPreview}${more}</div>
        `;
        }

        function renderRows(items) {
          if (selectAllCb) selectAllCb.checked = false; // Reset master on new page
          tbody.innerHTML = '';
          items.forEach((row) => {
            const tr = document.createElement('tr');
            const ttlText = (row.ttl === 0 || row.ttl === '0') ? '‚àû' : String(row.ttl);

            let ttlHtml = ttlText;
            if (row.days_remaining !== undefined && row.days_remaining !== null) {
              ttlHtml += `<br><small class="text-muted">(${row.days_remaining} d. rest.)</small>`;
            }

            tr.innerHTML = `
        <td><input type="checkbox" class="row-chk" value="${escapeHtml(row.ip)}"></td>
        <td>${escapeHtml(row.ip)}</td>
        <td>${escapeHtml(row.fecha_alta || '')}</td>
        <td class="small">${ttlHtml}</td>
        <td>${(row.tags && row.tags.length)
                ? row.tags.map(tagBadge).join(' ')
                : '<span class="text-muted">‚Äî</span>'
              }</td>
        <td>${alertsCellHtml(row)}</td>
        <td>
          <div class="d-flex gap-1 justify-content-end">
            ${(USER_ROLE !== 'view_only') ?
                `<button type="button" class="btn btn-sm btn-outline-primary" title="Editar TTL"
              onclick='openEditTTL("${escapeHtml(row.ip)}", ${JSON.stringify(row.tags || [])})'>
              <i class="bi bi-pencil"></i>
            </button>` : ''
              }
            <button type="button" class="btn btn-sm btn-outline-danger" title="Eliminar"
              onclick='confirmDeleteJS("${escapeHtml(row.ip)}", ${JSON.stringify(row.tags || [])})'>
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </td>
        `;
            tbody.appendChild(tr);
          });
          attachTableSelectionHandlers();
        }

        function updatePager(page, pageSize, total) {
          const pages = Math.max(1, Math.ceil((total || 0) / (pageSize || 50)));
          tableState.page = Math.min(Math.max(1, parseInt(page || 1, 10)), pages);
          pageInfo.textContent = `P√°gina ${tableState.page} de ${pages} ‚Äî ${total || 0} IPs`;
          prevBtn.disabled = (tableState.page <= 1); nextBtn.disabled = (tableState.page >= pages);
        }

        // ===>> Actualiza totales globales (incluye API y Tags)
        // ===>> Actualiza totales globales (incluye API y Tags)
        function updateCounters(counters) {
          if (!counters) return;
          const t = document.getElementById('totalCount');
          const m = document.getElementById('manualCount');
          const c = document.getElementById('csvCount');
          const a = document.getElementById('apiCount');

          if (t && counters.total !== undefined) t.textContent = counters.total;
          if (m && counters.manual !== undefined) m.textContent = counters.manual;
          if (c && counters.csv !== undefined) c.textContent = counters.csv;
          if (a && counters.api !== undefined) a.textContent = counters.api;

          // Actualizar lista din√°mica de tags
          // Necesitamos un contenedor con ID. Como reemplazamos el Jinja loop,
          // debemos asegurarnos de que el DIV padre tenga un ID o identificarlo.
          // Estrategia: Buscar el contenedor por clase o a√±adir ID en el HTML anterior.
          // Como no a√±ad√≠ ID en el paso anterior, lo haremos por selector relative o reload total.
          // Pero reloadTable recarga toda la pagina? No, solo datos JSON.

          // PLAN B: Como es complejo inyectar HTML bonito desde JS sin ID, 
          // y el usuario ya recibe la p√°gina renderizada por Jinja al recargar,
          // para simplificar, si recargas la p√°gina (F5) ya sale bien.
          // Si queremos que se actualice LIVE sin F5, necesitamos un ID en el container.

          // Voy a asumir que el usuario aceptar√° F5 para ver tags NUEVOS en la tarjeta,
          // pero los contadores de los existentes s√≠ podr√≠amos actualizarlos si tuvieran IDs.
          // Vamos a dejar esta funci√≥n limpia para no romper nada, y si el usuario pide live update, a√±adimos ID.
          // Por ahora eliminamos la referencia a IDs que ya no existen (tagMultiCount, tagBpeCount).
        }




        document.addEventListener("DOMContentLoaded", function () {
          // Inicializar l√≥gica de carga
          reloadTable(true);
          attachTableSelectionHandlers();

          // Renderizar historial de notificaciones
          renderList();

          // Renderizar toasts iniciales (Flash messages)
          if (window.newFlashes && window.newFlashes.length) {
            window.newFlashes.forEach(f => {
              // Mapeo categor√≠as Flask -> Bootstrap
              let cat = f.category || 'info';
              if (cat === 'message') cat = 'info';
              showInlineToast(cat, f.message);
            });
          }

          // Inicializar tags (Prioridad Alta)
          console.log("DOM Loaded (Revisado): Initializing Tags...");
          if (typeof window.refreshTagsUI === 'function') {
            window.refreshTagsUI();
          } else {
            console.error("Critical: window.refreshTagsUI not defined!");
          }

          // Inicializar lista de notificaciones
          if (typeof renderList === 'function') renderList();
        });

        // Funci√≥n Global para el Dropdown de Tags
        window.refreshTagsUI = function () {
          // DEBUG: Confirmar ejecuci√≥n
          console.log("refreshTagsUI called");

          const checkboxes = document.querySelectorAll(".tag-chk-manual");
          // Use querySelector to find the span inside the button explicitly if needed, but ID should be unique.
          const btnSpan = document.getElementById("tagsDropdownSpan");

          if (!btnSpan) {
            console.error("Error: tagsDropdownSpan not found");
            return;
          }

          const selected = Array.from(checkboxes)
            .filter(chk => chk.checked)
            .map(chk => chk.value);

          console.log("Selected tags:", selected);

          if (selected.length === 0) {
            btnSpan.textContent = "Seleccionar tags...";
            btnSpan.classList.add("text-muted");
            btnSpan.classList.remove("fw-bold");
          } else {
            btnSpan.textContent = selected.join(", ");
            btnSpan.classList.remove("text-muted");
            btnSpan.classList.add("fw-bold");
          }
        };

        // --- L√≥gica para quitar tags ---
        async function removeTag(element, ip, tag) {
          if (!confirm(`¬øSeguro que quieres quitar el tag "${tag}" de la IP ${ip}?`)) {
            return;
          }

          try {
            const res = await fetch('/api/remove-tag', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ ip: ip, tag: tag })
            });
            const data = await res.json();

            if (res.ok && data.ok) {
              // Eliminar visualmente el chip
            } else {
              showInlineToast("danger", data.error || "Error al eliminar tag");
            }
          } catch (e) {
            showInlineToast("danger", "Error de red al eliminar tag");
          }
        }

        window.confirmDeleteJS = function (ip, tags) {
          let msg = `¬øEliminar ${ip}?`;
          if (tags && (tags.includes('BPE') || tags.includes('bpe'))) {
            msg = `‚ö†Ô∏è ATENCI√ìN: La IP ${ip} es CR√çTICA (BPE).\n\nSe eliminar√° de TODAS las listas (Principal y
          BPE).\n\n¬øEst√°s seguro de continuar?`;
          }

          if (confirm(msg)) {
            // Enviar POST program√°tico
            const form = document.createElement('form');
            form.method = 'POST';
            form.style.display = 'none';

            const inp = document.createElement('input');
            inp.type = 'hidden';
            inp.name = 'delete_ip';
            inp.value = ip;

            form.appendChild(inp);
            document.body.appendChild(form);
            form.submit();
          }
        }

        // --- Edit TTL Logic ---
        let currentEditIp = null;
        let currentEditTags = [];

        window.openEditTTL = function (ip, tags) {
          currentEditIp = ip;
          currentEditTags = tags || [];

          const span = document.getElementById('editTTLIp');
          if (span) span.textContent = ip;

          // Open Modal
          const el = document.getElementById('modalEditTTL');
          if (el) {
            const modal = new bootstrap.Modal(el);
            modal.show();
          }
        };

        window.saveEditTTL = async function () {
          if (!currentEditIp) return;

          const sel = document.getElementById('editTTLSelect');
          const val = sel ? sel.value : "0";

          // Tomamos el bot√≥n que dispar√≥ el evento (si existe) o lo buscamos
          const btn = document.querySelector('#modalEditTTL .btn-primary');
          let orig = 'Guardar';
          if (btn) {
            orig = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
          }

          try {
            const res = await fetch('/update-ttl', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                ip: currentEditIp,
                ttl: val,
                tags: currentEditTags
              })
            });
            const d = await res.json();

            if (res.ok) {
              // Reload table to show new TTL
              if (typeof reloadTable === 'function') reloadTable(false);

              // Hide modal
              const el = document.getElementById('modalEditTTL');
              const modal = bootstrap.Modal.getInstance(el);
              if (modal) modal.hide();

              if (typeof showInlineToast === 'function') showInlineToast('success', 'TTL actualizado correctamente');
            } else {
              if (typeof showInlineToast === 'function') showInlineToast('danger', d.error || 'Error al actualizar TTL');
            }
          } catch (e) {
            console.error(e);
            if (typeof showInlineToast === 'function') showInlineToast('danger', 'Error de conexi√≥n');
          } finally {
            if (btn) {
              btn.disabled = false;
              btn.innerHTML = orig;
            }
          }
        };
    </script>
    <!-- MODAL GR√ÅFICAS -->
    <div class="modal fade" id="metricsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-xl">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-graph-up me-2"></i>Evoluci√≥n de M√©tricas</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row g-4">
              <!-- Gr√°fico Total -->
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="card-header bg-transparent fw-bold text-center">Total IPs Activas</div>
                  <div class="card-body">
                    <canvas id="chartTotal"></canvas>
                  </div>
                </div>
              </div>
              <!-- Gr√°fico Fuentes -->
              <div class="col-lg-6">
                <div class="card h-100">
                  <div class="card-header bg-transparent fw-bold text-center">Distribuci√≥n por Origen</div>
                  <div class="card-body">
                    <canvas id="chartSources"></canvas>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL GESTI√ìN DE TAGS MASIVA -->
    <div class="modal fade" id="modalManageTags" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-tags me-2"></i>Gestionar Tags</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <p>Acci√≥n sobre <strong id="tagManageCount">0</strong> IPs seleccionadas.</p>

            <div class="mb-3">
              <label for="tagInputBulk" class="form-label">Nombre del Tag</label>
              <input type="text" class="form-control" id="tagInputBulk" placeholder="Ej: BPE, Revisar, Nuevo...">
              <div class="form-text">Escribe el tag que quieres a√±adir o quitar.</div>
            </div>

            <div class="d-flex justify-content-between gap-2">
              <button type="button" class="btn btn-outline-danger w-50" onclick="submitManageTags('remove')">
                <i class="bi bi-dash-circle me-1"></i> Quitar Tag
              </button>
              <button type="button" class="btn btn-primary w-50" onclick="submitManageTags('add')">
                <i class="bi bi-plus-circle me-1"></i> A√±adir Tag
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL HISTORIAL DE PRUEBAS (SALUD) -->
    <div class="modal fade" id="modalTestHistory" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title text-info"><i class="bi bi-heart-pulse me-2"></i>Historial de Salud
              (Diagn√≥sticos)
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-hover mb-0" style="font-size:0.9rem;">
                <thead class="table-light">
                  <tr>
                    <th>Fecha</th>
                    <th>Estado</th>
                    <th>Salida / Output</th>
                    <th>Actor</th>
                  </tr>
                </thead>
                <tbody id="testHistTableBody">
                </tbody>
              </table>
            </div>
            <div id="testHistLoading" class="text-center p-4">
              <span class="spinner-border text-primary"></span>
            </div>
            <div id="testHistEmpty" class="text-center p-4 d-none text-muted">
              No hay pruebas registradas.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        /**
         * Dashboard Dashboard Utilities and Async Operations
         */

        // Unified escapeHtml for consistency
        function escapeHtml(str) {
          if (!str) return '';
          const div = document.createElement('div');
          div.textContent = str;
          return div.innerHTML;
        }

        // Initialize Dashboard Components
        document.addEventListener("DOMContentLoaded", () => {
          // Init Graphs Button
          const btnShowGraphs = document.getElementById("btnShowGraphs");
          if (btnShowGraphs) {
            btnShowGraphs.addEventListener("click", () => {
              fetchAndRenderGraphs();
            });
          }

          // Ensure other UI elements are ready
          console.log("Dashboard functionality initialized.");
        });

        // --- Metrics and Charts ---
        let chartTotalInstance = null;
        let chartSourcesInstance = null;

        function getColorForSource(key) {
          const colors = {
            "manual": "#0d6efd",
            "csv": "#0dcaf0",
            "api": "#ffc107"
          };
          if (colors[key]) return colors[key];
          let hash = 0;
          for (let i = 0; i < key.length; i++) hash = key.charCodeAt(i) + ((hash << 5) - hash);
          const c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
          return "#" + "00000".substring(0, 6 - c.length) + c;
        }

        async function fetchAndRenderGraphs() {
          const modalEl = document.getElementById('metricsModal');
          const myModal = new bootstrap.Modal(modalEl);
          myModal.show();

          try {
            const res = await fetch("/api/counters/history");
            if (!res.ok) throw new Error("HTTP " + res.status);
            const data = await res.json();

            if (!data || data.length === 0) {
              console.warn("No history data available for graphs");
              return;
            }

            const labels = data.map(d => d.date);
            const totals = data.map(d => d.total);
            const allSrcKeys = new Set();
            data.forEach(d => {
              if (d.sources) Object.keys(d.sources).forEach(k => allSrcKeys.add(k));
            });

            const sourceDatasets = Array.from(allSrcKeys).map((key) => {
              return {
                label: key,
                data: data.map(d => (d.sources ? (d.sources[key] || 0) : 0)),
                backgroundColor: getColorForSource(key),
                borderColor: getColorForSource(key),
                fill: false,
                tension: 0.2
              };
            });

            const ctxTotal = document.getElementById("chartTotal").getContext("2d");
            if (chartTotalInstance) chartTotalInstance.destroy();
            chartTotalInstance = new Chart(ctxTotal, {
              type: 'line',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Total IPs',
                  data: totals,
                  borderColor: '#0d6efd',
                  backgroundColor: 'rgba(13, 110, 253, 0.1)',
                  fill: true,
                  tension: 0.3
                }]
              },
              options: { responsive: true }
            });

            const ctxSrc = document.getElementById("chartSources").getContext("2d");
            if (chartSourcesInstance) chartSourcesInstance.destroy();
            chartSourcesInstance = new Chart(ctxSrc, {
              type: 'line',
              data: {
                labels: labels,
                datasets: sourceDatasets
              },
              options: { responsive: true }
            });

          } catch (err) {
            console.error("Error loading graphs:", err);
            showInlineToast("danger", "Error al cargar datos de gr√°ficas");
          }
        }

        // --- Diagnostics (Salud) ---
        async function runDiagnostics() {
          const btn = document.getElementById("runDiagnosticsBtn");
          if (!btn) return;
          const orig = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span> Ejecutando...`;

          try {
            const r = await fetch("/api/run-diagnostics", { method: "POST" });
            const d = await r.json();

            if (r.ok && (d.ok || (d.extra && d.extra.ok))) {
              showInlineToast("success", "Autodiagn√≥stico: TODO OK");
            } else {
              showInlineToast("danger", "Autodiagn√≥stico: FALLO (ver historial)");
              if (d.extra && d.extra.output) console.error(d.extra.output);
            }
          } catch (e) {
            console.error("Diagnostic execution error:", e);
            showInlineToast("danger", "Error invocando diagn√≥stico: " + e.message);
          } finally {
            btn.disabled = false;
            btn.innerHTML = orig;
          }
        }

        // --- Maintenance Toggle ---
        async function toggleMaintenance(active) {
          try {
            const res = await fetch('/maintenance/toggle', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ active: active })
            });
            const d = await res.json();
            if (res.ok) {
              window.location.reload();
            } else {
              alert("Error: " + (d.error || res.statusText));
              const el = document.getElementById('maintenanceSwitch');
              if (el) el.checked = !active;
            }
          } catch (e) {
            console.error("Maintenance toggle error:", e);
            alert("Error de conexi√≥n: " + e.message);
            const el = document.getElementById('maintenanceSwitch');
            if (el) el.checked = !active;
          }
        }

        // --- IP History (Modal) ---
        // --- IP History (Modal) ---
        async function openHistory(ip) {
          const modalEl = document.getElementById('modalHistory');
          if (!modalEl) return;

          const modal = new bootstrap.Modal(modalEl);
          document.getElementById('histIpLabel').textContent = ip;

          const tbody = document.getElementById('histTableBody');
          const loading = document.getElementById('histLoading');
          const empty = document.getElementById('histEmpty');

          if (tbody) tbody.innerHTML = '';
          if (loading) loading.classList.remove('d-none');
          if (empty) empty.classList.add('d-none');

          modal.show();

          try {
            const res = await fetch(`/api/estado/${encodeURIComponent(ip)}`, {
              credentials: 'include',
              headers: { 'Accept': 'application/json' }
            });
            if (!res.ok) throw new Error("Fetch failed: " + res.status);
            const data = await res.json();

            const history = data.history || [];
            if (loading) loading.classList.add('d-none');

            if (history.length === 0) {
              if (empty) empty.classList.remove('d-none');
              return;
            }

            const rows = history.map(h => {
              const dateStr = h.ts ? new Date(h.ts).toLocaleString() : '-';
              const tags = (h.tags || []).join(', ');
              const note = h.note || '-';
              const action = h.action || 'update';
              const user = h.user || 'system';
              const source = h.source || '-';

              return `
              <tr>
                <td class="small text-nowrap">${escapeHtml(dateStr)}</td>
                <td class="small">${escapeHtml(user)}</td>
                <td class="small"><span class="badge bg-secondary text-dark bg-opacity-10 border">${escapeHtml(action)}</span></td>
                <td class="small">${escapeHtml(source)}</td>
                <td class="small">${escapeHtml(tags)}</td>
                <td class="small text-muted">${escapeHtml(note)}</td>
              </tr>
            `;
            }).join('');

            if (tbody) tbody.innerHTML = rows;

          } catch (e) {
            console.error("History fetch error:", e);
            if (loading) loading.classList.add('d-none');
            if (tbody) tbody.innerHTML = `<tr><td colspan="6" class="text-danger text-center">Error cargando historial</td></tr>`;
          }
        }

        // --- Global Health History (Modal) ---
        async function showTestHistory(autoShow = true) {
          const modalEl = document.getElementById('modalTestHistory');
          if (!modalEl) return;

          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          if (autoShow) modal.show();

          const tbody = document.getElementById('testHistTableBody');
          const loading = document.getElementById('testHistLoading');
          const empty = document.getElementById('testHistEmpty');

          if (tbody) tbody.innerHTML = '';
          if (loading) loading.classList.remove('d-none');
          if (empty) empty.classList.add('d-none');

          try {
            const res = await fetch('/api/test-history');
            if (!res.ok) throw new Error("Fetch failed: " + res.status);
            const data = await res.json();

            if (loading) loading.classList.add('d-none');

            const history = data.history || [];
            if (history.length === 0) {
              if (empty) empty.classList.remove('d-none');
              return;
            }

            if (tbody) {
              tbody.innerHTML = history.map(h => {
                const date = h.ts ? new Date(h.ts).toLocaleString() : '-';
                const badge = h.success
                  ? '<span class="badge bg-success">OK</span>'
                  : '<span class="badge bg-danger">FAIL</span>';

                // Simplificar output para la tabla
                let shortOut = '-';
                if (h.output) {
                  // Si es muy largo, recortar.
                  shortOut = h.output.length > 80 ? h.output.substring(0, 80) + '...' : h.output;
                }

                return `
                <tr>
                  <td class="small text-nowrap">${escapeHtml(date)}</td>
                  <td>${badge}</td>
                  <td class="small text-muted font-monospace" style="font-size:0.85em;" title="${escapeHtml(h.output || '')}">${escapeHtml(shortOut)}</td>
                  <td class="small">${escapeHtml(h.actor || 'system')}</td>
                </tr>
              `;
              }).join('');
            }
          } catch (e) {
            console.error("Test history fetch error:", e);
            if (loading) loading.classList.add('d-none');
            if (tbody) tbody.innerHTML = '<tr><td colspan="4" class="text-danger text-center">Error cargando historial</td></tr>';
          }
        }

        // --- Diagnostics (Salud) ---
        async function runDiagnostics() {
          const btn = document.getElementById("runDiagnosticsBtn");
          if (!btn) return;
          const orig = btn.innerHTML;
          btn.disabled = true;
          btn.innerHTML = `<span class="spinner-border spinner-border-sm me-1"></span> Ejecutando...`;

          try {
            const r = await fetch("/api/run-diagnostics", { method: "POST" });
            const d = await r.json();

            if (r.ok && (d.ok || (d.extra && d.extra.ok))) {
              showInlineToast("success", "Autodiagn√≥stico: TODO OK");
            } else {
              showInlineToast("danger", "Autodiagn√≥stico: FALLO (ver historial)");
              if (d.extra && d.extra.output) console.error(d.extra.output);
            }

            // == AUTOMATICAMENTE ABRIR EL HISTORIAL/RESUMEN ==
            // Damos un peque√±o delay para que la BD haya guardado
            setTimeout(() => {
              showTestHistory(true);
            }, 500);

          } catch (e) {
            console.error("Diagnostic execution error:", e);
            showInlineToast("danger", "Error invocando diagn√≥stico: " + e.message);
          } finally {
            btn.disabled = false;
            btn.innerHTML = orig;
          }
        }
    </script>

    <!-- ROBUST FALLBACK SCRIPT FOR TAGS UI -->
    <script>
        (function () {
          // Redefinici√≥n segura de la funci√≥n de UI
          window.refreshTagsUI = function () {
            // console.log("Fallback refreshTagsUI called");
            const checkboxes = document.querySelectorAll(".tag-chk-manual");
            const btnSpan = document.getElementById("tagsDropdownSpan");

            if (!btnSpan) return;

            const selected = Array.from(checkboxes)
              .filter(chk => chk.checked)
              .map(chk => chk.value);

            if (selected.length === 0) {
              btnSpan.textContent = "Seleccionar tags...";
              btnSpan.classList.add("text-muted");
              btnSpan.classList.remove("fw-bold");
            } else {
              btnSpan.textContent = selected.join(", ");
              btnSpan.classList.remove("text-muted");
              btnSpan.classList.add("fw-bold");
            }
          };

          // Ejecutar inmediatamente al final del body (garantiza que el DOM existe)
          try {
            window.refreshTagsUI();
          } catch (e) { console.error("Fallback init error", e); }
        })();
    </script>
</body>

</html>