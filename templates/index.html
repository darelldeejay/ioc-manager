<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>IOC Manager</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Arranque de tema: evita flash claro si el usuario guard√≥ "dark" -->
  <script>
  (function () {
    try {
      if (localStorage.getItem('theme') === 'dark') {
        var s = document.createElement('style');
        s.id = 'anti-flash-dark';
        s.innerHTML = 'html,body{background-color:#121212 !important;color:#e9ecef !important;}';
        document.head.appendChild(s);
        document.documentElement.setAttribute('data-theme','dark');
      } else {
        document.documentElement.setAttribute('data-theme','light');
      }
    } catch (e) {}
  })();
  </script>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Google Font Inter for modern typography -->
 <link rel="preconnect" href="https://fonts.googleapis.com">
 <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
 <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Estilos propios -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/index.css') }}">
  
  <style>

    /* ====== Cabecera principal ‚ÄúGestor IOC Manager‚Äù ====== */
.title-gestor {
  font-weight: 500;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  font-size: 0.8rem;
  color: var(--text-muted-dark);
}

.title-ioc {
  display: inline-block;
  margin-left: 0.4rem;
  font-size: 1.9rem;
  font-weight: 700;
  letter-spacing: 0.06em;
  text-transform: uppercase;
  background: linear-gradient(120deg, #22d3ee, #38bdf8, #a855f7);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
}

    /* ====== Barra de paginaci√≥n bajo la tabla ====== */
#pagerBar {
  margin-top: 1rem;
  padding: 0.45rem 0.9rem;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.35);
  background: rgba(15, 23, 42, 0.85);
}
[data-theme="light"] #pagerBar {
  border-color: #e5e7eb;
  background: #ffffff;
}

/* Texto "P√°gina X de Y ‚Äî N IPs" */
#pageInfo {
  font-size: 0.8rem;
  opacity: 0.85;
}

/* Botones ¬´ y ¬ª un poco m√°s c√≥modos */
#pagerBar .btn-group .btn {
  min-width: 2.3rem;
  padding-inline: 0.6rem;
}

/* Ajuste de colores en modo claro */
[data-theme="light"] .title-gestor {
  color: var(--text-muted-light);
}

/* Subt√≠tulo bajo el t√≠tulo principal */
.text-center p.text-muted.mt-2 {
  font-size: 0.9rem;
  opacity: 0.85;
}

      /* Personalizaci√≥n del bot√≥n A√±adir */
#addManualBtn {
  background-color: var(--accent);
  border-color: var(--accent);
  color: #0f172a; /* texto oscuro para buen contraste */
}

#addManualBtn:hover {
  filter: brightness(1.05);
}    

    /* Personalizaci√≥n bot√≥n Subir archivo */
#uploadCsvBtn {
  background-color: var(--accent);
  border-color: var(--accent);
  color: #0f172a; /* contraste con fondo cian */
}

#uploadCsvBtn:hover {
  filter: brightness(1.05);
}

    /* Fuente global para toda la aplicaci√≥n */
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
}

    .metric-card {
  border-radius: 1rem;
  border: 1px solid rgba(148, 163, 184, 0.25); /* oscuro */
  background: rgba(15, 23, 42, 0.85);         /* oscuro */
  box-shadow: 0 18px 35px rgba(15, 23, 42, 0.85);
}
[data-theme="light"] .metric-card {
  border-color: #e5e7eb; 
  background: #ffffff;
  box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
}

    /* Personalizaci√≥n Previsualizar */
#btnPreviewDelete {
    background-color: var(--accent-soft);
    border-color: var(--accent);
    color: var(--accent);
}
#btnPreviewDelete:hover {
    background-color: var(--accent);
    color: #0f172a;
}

/* Personalizaci√≥n Eliminar por patr√≥n */
#btnDeletePattern {
    background-color: var(--danger);
    border-color: var(--danger);
    color: #fff;
}
#btnDeletePattern:hover {
    filter: brightness(1.05);
}

/* Personalizaci√≥n Eliminar todas */
#btnDeleteAll {
    background-color: rgba(239, 68, 68, 0.1); /* rojo suave */
    border-color: var(--danger);
    color: var(--danger);
}
#btnDeleteAll:hover {
    background-color: var(--danger);
    color: #fff;
}

    /* Contenedor de tabla estilizado */
.table-responsive {
    border-radius: 1rem;
    border: 1px solid var(--border-subtle-dark);
    background: rgba(15, 23, 42, 0.85);
    box-shadow: 0 18px 35px rgba(15, 23, 42, 0.85);
}
[data-theme="light"] .table-responsive {
    border-color: #e5e7eb;
    background: #ffffff;
    box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
}

/* Cabecera de tabla */
#ipsTable thead th {
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    border-bottom: none;
    color: var(--text-muted-dark);
}
[data-theme="light"] #ipsTable thead th {
    color: var(--text-muted-light);
}

/* Filas */
#ipsTable tbody tr:hover {
    background: rgba(31, 41, 55, 0.9);
    transform: translateY(-1px);
}
[data-theme="light"] #ipsTable tbody tr:hover {
    background: #f9fafb;
}

/* Badges de tags */
.badge-tag {
    border-radius: 999px;
    padding: 0.35rem 0.75rem;
    font-size: 0.75rem;
    font-weight: 500;
}

/* Badge de alertas */
.badge-alert {
    border-radius: 999px;
    font-size: 0.75rem;
    padding: 0.28rem 0.7rem;
}

    body[data-theme="dark"] .offcanvas-notifs {
    background: #020617;
    color: var(--text-main-dark);
    border-left: 1px solid rgba(148, 163, 184, 0.4);
}

body[data-theme="dark"] .offcanvas-notifs .list-group-item {
    background: transparent;
    border-color: rgba(55, 65, 81, 0.7);
}

body[data-theme="light"] .offcanvas-notifs {
    background: #ffffff;
    color: var(--text-main-light);
    border-left: 1px solid #e5e7eb;
}

body[data-theme="light"] .offcanvas-notifs .list-group-item {
    background: transparent;
    border-color: #e5e7eb;
}

    #toastContainer .toast {
    border-radius: 0.75rem;
    box-shadow: 0 16px 30px rgba(15, 23, 42, 0.8);
}
 
    /* Global design variables for dual theme (light/dark) and accent colors */
:root {
  --accent: #22d3ee;
  --accent-soft: rgba(34, 211, 238, 0.14);
  --danger: #ef4444;
  --warning: #f59e0b;
  --success: #10b981;
  --text-main-dark: #e5e7eb;
  --text-muted-dark: #9ca3af;
  --text-main-light: #111827;
  --text-muted-light: #6b7280;
}
    body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
}

    /* Botones generales adaptados a la paleta */
.btn {
    border-radius: 999px;
    font-weight: 500;
    transition: filter 0.15s ease, transform 0.15s ease;
}

/* Bot√≥n primario: cian (A√±adir, Subir CSV si se le pone .btn-primary) */
.btn-primary {
    background-color: var(--accent);
    border-color: var(--accent);
    color: #0f172a;
}
.btn-primary:hover {
    filter: brightness(1.05);
}

/* Bot√≥n de peligro: rojo para acciones destructivas */
.btn-danger {
    background-color: var(--danger);
    border-color: var(--danger);
    color: #fff;
}
.btn-danger:hover {
    filter: brightness(1.05);
}

/* Bot√≥n de aviso (poco usado en tu UI actual) */
.btn-warning {
    background-color: var(--warning);
    border-color: var(--warning);
    color: #111827;
}
.btn-warning:hover {
    filter: brightness(1.05);
}

/* Botones outlines con tono cian suave */
.btn-outline-secondary {
    border-color: var(--accent);
    color: var(--accent);
}
.btn-outline-secondary:hover {
    background-color: var(--accent-soft);
    color: #0f172a;
}
    
    /* ---------- UI refinements ---------- */

    /* Hints legibles tambi√©n en modo oscuro */
    .hint-box {
      font-size: .9rem;
      border: 1px dashed #ced4da;
      border-radius: .5rem;
      padding: .75rem;
      background: #f8f9fa;
      color: #212529;
    }
    .bg-dark .hint-box {
      border-color: #495057;
      background: #1f1f1f;
      color: #e9ecef;
    }

    /* Placeholders visibles en oscuro */
    .bg-dark ::placeholder { color: #adb5bd !important; opacity: 1; }
    .bg-dark .form-control, .bg-dark .form-select {
      background-color: #1f1f1f; color: #e9ecef; border-color: #495057;
    }
    .bg-dark .table { color: #e9ecef; }

    /* TOASTS: arriba a la derecha, bajo la cabecera */
    #toast-portal{
      position: fixed;
      top: 64px;
      right: 16px;
      left: auto;
      transform: none;
      z-index: 1060;
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-width: min(90vw, 560px);
      pointer-events: none;
      align-items: flex-end;
    }
    .toast{ pointer-events: auto; border: none !important; box-shadow: 0 6px 18px rgba(0,0,0,.25); }

    /* ======== ESTILO PERSONALIZADO PARA LA BARRA DE FILTRO ======== */
#serverToolbar {
    border-radius: 1rem;
    border: 1px solid var(--border-subtle-dark);
    background: rgba(15, 23, 42, 0.85);
    box-shadow: 0 18px 35px rgba(15, 23, 42, 0.85);
    padding: 1rem;
}
[data-theme="light"] #serverToolbar {
    border-color: #e5e7eb;
    background: #ffffff;
    box-shadow: 0 14px 30px rgba(15, 23, 42, 0.08);
}

/* Campo de b√∫squeda */
#qInput {
    border-radius: 999px;
    background-color: #020617;
    border: 1px solid rgba(148, 163, 184, 0.45);
    color: var(--text-main-dark);
}
[data-theme="light"] #qInput {
    background-color: #ffffff;
    border-color: #d1d5db;
    color: var(--text-main-light);
}
#qInput:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 1px rgba(34, 211, 238, 0.45);
}

/* Bot√≥n limpiar filtro */
#clearTableFilters {
    border-radius: 999px;
    border-color: var(--accent);
    color: var(--accent);
}
#clearTableFilters:hover {
    background-color: var(--accent-soft);
    color: #0f172a;
}

    /* Bot√≥n Notificaciones (en cabecera) con burbuja */
    #notif-btn{ position:relative; }
    #notif-badge{ position:absolute; top:-6px; right:-8px; }

    /* Logo esquina (SIN TOCAR, abajo derecha) */
    #corner-logo{
      position:fixed; bottom:16px; right:16px; width:96px; height:auto; opacity:.85; z-index:1040;
    }
    @media (max-width:576px){ #corner-logo{ width:68px; } }

    /* Controles de tabla */
    .toolbar-grid {
      display: grid;
      grid-template-columns: 1fr 1fr repeat(5, auto);
      gap: .5rem;
      align-items: end;
    }
    @media (max-width: 992px){
      .toolbar-grid { grid-template-columns: 1fr 1fr 1fr; }
    }

    /* ====== Refuerzo DARK por data-theme (cubre gap antes de JS) ====== */
    html[data-theme="dark"] body { background-color: #121212; color: #e9ecef; }
    html[data-theme="dark"] .form-control, html[data-theme="dark"] .form-select {
      background-color: #1f1f1f; color: #e9ecef; border-color: #495057;
    }
    html[data-theme="dark"] ::placeholder { color: #adb5bd !important; opacity: 1; }
    html[data-theme="dark"] .offcanvas, html[data-theme="dark"] .modal-content, html[data-theme="dark"] .card {
      background-color: #1f1f1f; color: #e9ecef; border-color: #343a40;
    }
    html[data-theme="dark"] .table {
      color: #e9ecef;
      --bs-table-bg: #1d1d1d;
      --bs-table-striped-bg: #232323;
      --bs-table-hover-bg: #2b2b2b;
      --bs-table-border-color: #2e2e2e;
    }
    html[data-theme="dark"] .pagination .page-link {
      background-color: #1f1f1f; color: #e9ecef; border-color: #2e2e2e;
    }
    html[data-theme="dark"] .pagination .page-item.active .page-link {
      background-color: #0d6efd; color: #fff; border-color: #0d6efd;
    }
    html[data-theme="dark"] #offcanvasNotifs .form-control, html[data-theme="dark"] .form-select {
      background-color: #1f1f1f; color: #e9ecef; border-color: #343a40;
    }
    html[data-theme="dark"] #notifList > div {
      background-color: #1f1f1f !important; color: #e9ecef !important; border-color: #2e2e2e !important;
    }
    html[data-theme="dark"] #notifCountInfo { color: #cbd3da !important; }
    html[data-theme="dark"] #notif-btn.btn-outline-primary { color: #fff; background-color: #0d6efd; border-color: #0d6efd; }

    html[data-theme="dark"] body.bg-light { background-color: #121212 !important; color: #e9ecef !important; }

    /* Resaltado de filas seleccionadas (bulk) */
    .table-active-selected { outline: 2px solid rgba(13,110,253,.35); }
    html[data-theme="dark"] .table-active-selected { outline-color: rgba(13,110,253,.55); }

    /* Celda de alertas: texto peque√±o para lista de IDs */
    .alert-ids-list {
      font-size: 0.8rem;
      margin-top: 2px;
      max-width: 260px;
      word-wrap: break-word;
      white-space: normal;
    }
  </style>
</head>
<body class="bg-light">

<div class="container py-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <button class="btn btn-outline-secondary btn-sm" onclick="toggleTheme()">üåô Modo Oscuro</button>

    <div class="d-flex align-items-center gap-2">
      <!-- Bot√≥n Notificaciones (arriba derecha) -->
      <div class="btn-group">
        <button id="notif-btn" class="btn btn-outline-primary btn-sm"
                type="button" data-bs-toggle="offcanvas"
                data-bs-target="#offcanvasNotifs" aria-controls="offcanvasNotifs">
          üîî Notificaciones
          <span id="notif-badge" class="badge text-bg-danger rounded-pill d-none">0</span>
        </button>
        <button id="markReadBtn" class="btn btn-outline-primary btn-sm" title="Marcar como le√≠do (sin abrir)">
          ‚úîÔ∏è
        </button>
      </div>

      <a href="/logout" class="btn btn-outline-danger btn-sm">Logout</a>
    </div>
  </div>

 <div class="text-center mb-3">
  <h2 class="fw-bold mb-1">
    <span class="title-gestor">Gestor</span>
    <span class="title-ioc">IOC&nbsp;Manager</span>
  </h2>
  <div class="mx-auto" style="width:120px; height:3px; background:#0d6efd; border-radius:2px;"></div>
  <p class="text-muted mt-2">
    Herramienta de seguridad para la gesti√≥n de IOCs
  </p>
</div>

  <!-- ======= RESUMEN AMPLIADO ======= -->
<!-- NUEVAS TARJETAS DE RESUMEN -->
<div class="row g-3 mb-4">
  <!-- Tarjeta total IPs activas -->
  <div class="col-12 col-md-6 col-xl-3">
    <div class="card metric-card h-100 border-0">
      <div class="card-body">
        <h6 class="text-uppercase mb-1">IPs activas</h6>
        <div class="display-6">{{ total_ips or 0 }}</div>
        <small class="text-muted">En todos los feeds</small>
      </div>
    </div>
  </div>
  <!-- Tarjeta IPs por origen -->
  <div class="col-12 col-md-6 col-xl-3">
    <div class="card metric-card h-100 border-0">
      <div class="card-body">
        <h6 class="text-uppercase mb-1">Por origen</h6>
        <div class="d-flex justify-content-between mt-2">
          <div>
            <span class="badge bg-primary">Manual</span>
            <div class="fs-4">{{ contador_manual or 0 }}</div>
          </div>
          <div>
            <span class="badge bg-info text-dark">CSV</span>
            <div class="fs-4">{{ contador_csv or 0 }}</div>
          </div>
          <div>
            <span class="badge bg-warning text-dark">API</span>
            <div class="fs-4">{{ contador_api or 0 }}</div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Tarjeta IPs por tag -->
  <div class="col-12 col-md-6 col-xl-3">
    <div class="card metric-card h-100 border-0">
      <div class="card-body">
        <h6 class="text-uppercase mb-1">Por tag</h6>
        <div class="d-flex flex-column gap-1 mt-2">
          <div class="d-flex justify-content-between align-items-center">
            <span class="badge rounded-pill text-bg-primary">Multicliente</span>
            <span class="fs-5">{{ contador_tags.get('Multicliente', 0) }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="badge rounded-pill text-bg-warning text-dark">BPE</span>
            <span class="fs-5">{{ contador_tags.get('BPE', 0) }}</span>
          </div>
          <div class="d-flex justify-content-between align-items-center">
            <span class="badge rounded-pill text-bg-secondary">Test</span>
            <span class="fs-5">{{ contador_tags.get('Test', 0) }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <!-- Tarjeta backups -->
  <div class="col-12 col-md-6 col-xl-3">
    <div class="card metric-card h-100 border-0">
      <div class="card-body">
        <h6 class="text-uppercase mb-1">Backups</h6>
        <p class="mb-2">
          <small class="text-muted">
            Backup diario autom√°tico si hay cambios.
          </small>
        </p>
        <a href="{{ url_for('backup_list') }}" class="btn btn-outline-secondary btn-sm">
          <i class="bi bi-clock-history"></i> Ver backups
        </a>
      </div>
    </div>
  </div>
</div>
  <!-- ======= FIN RESUMEN AMPLIADO ======= -->

  <!-- Botones de backup -->
  <div class="d-flex gap-2 justify-content-center mb-3">
    <a class="btn btn-outline-secondary btn-sm" href="/backup/latest.zip">‚¨áÔ∏è Descargar √∫ltimo backup</a>
    <form method="POST" action="/backup/now" class="d-inline">
      <button class="btn btn-outline-primary btn-sm" type="submit">üíæ Backup ahora</button>
    </form>
  </div>

  <!-- Solo errores graves si el backend los env√≠a en 'error' -->
  {% if error %}
    <div class="alert alert-danger mt-2">{{ error }}</div>
  {% endif %}

  <form id="mainForm" method="POST" enctype="multipart/form-data" class="mt-3">
    <input type="hidden" name="source" value="web">

    <!-- Navegaci√≥n de pesta√±as -->
<ul class="nav nav-pills mb-3" id="formsTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-manual" data-bs-toggle="pill"
            data-bs-target="#pane-manual" type="button" role="tab"
            aria-controls="pane-manual" aria-selected="true">
      <i class="bi bi-plus-circle me-1"></i> Alta manual
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-csv" data-bs-toggle="pill"
            data-bs-target="#pane-csv" type="button" role="tab"
            aria-controls="pane-csv" aria-selected="false">
      <i class="bi bi-file-earmark-spreadsheet me-1"></i> Carga CSV/TXT
    </button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-delete" data-bs-toggle="pill"
            data-bs-target="#pane-delete" type="button" role="tab"
            aria-controls="pane-delete" aria-selected="false">
      <i class="bi bi-trash me-1"></i> Eliminaci√≥n por patr√≥n
    </button>
  </li>
</ul>

    <div class="tab-content" id="actionsTabContent">
  <div class="tab-pane fade show active" id="pane-manual" role="tabpanel" aria-labelledby="tab-manual">
    <!-- Alta manual -->
<div class="row g-3 mb-1 align-items-end">
    <!-- IP -->
  <div class="col-lg-5">
    <label for="ipInput" class="form-label small mb-1">IP / Red / Rango / IP+M√°scara</label>
    <input id="ipInput" type="text" class="form-control" name="ip" autocomplete="off"
           placeholder="Ej: 1.2.3.4 ¬∑ 1.2.3.0/24 ¬∑ 1.2.3.4-1.2.3.20">
    <div id="ipFeedback" class="invalid-feedback"></div>
  </div>

  <!-- TTL -->
  <div class="col-lg-2">
    <label class="form-label small mb-1">TTL</label>
    <select class="form-select" name="ttl_manual">
      <option value="permanente" selected>Permanente</option>
      <option value="1">1 d√≠a</option>
      <option value="3">3 d√≠as</option>
      <option value="7">7 d√≠as</option>
      <option value="30">30 d√≠as</option>
    </select>
  </div>

  <!-- Tags (obligatorio) -->
  <div class="col-lg-3">
    <label class="form-label small mb-1">Aplicar a</label>
    <div id="tagManualGroup" class="d-flex flex-wrap align-items-center gap-3">
      <div class="form-check m-0">
        <input class="form-check-input tag-manual" type="checkbox" value="Multicliente" id="tagManualMulti">
        <label class="form-check-label" for="tagManualMulti">Multicliente</label>
      </div>
      <div class="form-check m-0">
        <input class="form-check-input tag-manual" type="checkbox" value="BPE" id="tagManualBpe">
        <label class="form-check-label" for="tagManualBpe">BPE</label>
      </div>
      <input type="hidden" id="tagsManualInput" name="tags_manual" value="">
    </div>
    <div id="tagManualFeedback" class="invalid-feedback" style="display:none;">
      Selecciona al menos un tag (Multicliente y/o BPE).
    </div>
  </div>

  <!-- Botones -->
  <div class="col-lg-2">
    <div class="d-flex gap-2">
      <button id="addManualBtn" type="submit" class="btn btn-success w-100">A√±adir</button>
      <button type="button" class="btn btn-danger d-none d-lg-inline-block"
              data-bs-toggle="modal" data-bs-target="#confirmDeleteAll">
        Eliminar todas
      </button>
    </div>
    <!-- Eliminar todas en m√≥vil (debajo para no apretar la fila) -->
    <button type="button" class="btn btn-danger mt-2 w-100 d-lg-none"
            data-bs-toggle="modal" data-bs-target="#confirmDeleteAll">
      Eliminar todas
    </button>
  </div>
</div>

<!-- Ayuda de formatos (fuera de la fila para no desalinear) -->
<div class="row mb-3">
  <div class="col-12">
    <div class="form-text small">
      Formatos admitidos: IP individual ¬∑ CIDR ¬∑ rango ¬∑ IP + m√°scara (p. ej. 1.2.3.0 255.255.255.0)
    </div>
  </div>
</div>
  </div>

  <div class="tab-pane fade" id="pane-csv" role="tabpanel" aria-labelledby="tab-csv">
    <!-- Subida por CSV -->
<div class="row g-3 mb-1 align-items-end">
  <!-- Archivo -->
  <div class="col-lg-5">
    <label class="form-label small mb-1">Seleccionar archivo</label>
    <input class="form-control" type="file" id="file" name="file" accept=".csv,.txt">
  </div>

  <!-- TTL global para CSV -->
  <div class="col-lg-2">
    <label class="form-label small mb-1">TTL para todas las filas</label>
    <select class="form-select" id="ttl_csv" name="ttl_csv">
      <option value="permanente" selected>Permanente</option>
      <option value="1">1 d√≠a</option>
      <option value="3">3 d√≠as</option>
      <option value="7">7 d√≠as</option>
      <option value="30">30 d√≠as</option>
    </select>
  </div>

  <!-- Tags CSV -->
  <div class="col-lg-3">
    <label class="form-label small mb-1">Aplicar a (todas las filas)</label>
    <div id="tagCsvGroup" class="d-flex flex-wrap align-items-center gap-3">
      <div class="form-check m-0">
        <input class="form-check-input tag-csv" type="checkbox" value="Multicliente" id="tagCsvMulti">
        <label class="form-check-label" for="tagCsvMulti">Multicliente</label>
      </div>
      <div class="form-check m-0">
        <input class="form-check-input tag-csv" type="checkbox" value="BPE" id="tagCsvBpe">
        <label class="form-check-label" for="tagCsvBpe">BPE</label>
      </div>
      <input type="hidden" id="tagsCsvInput" name="tags_csv" value="">
    </div>
  </div>

<!-- ‚úÖ Feedback visual para CSV sin tags -->
<div id="tagCsvFeedback" class="invalid-feedback" style="display:none;">
  Selecciona al menos un tag (Multicliente y/o BPE) para el CSV.
</div>

  <!-- Botones -->
  <div class="col-lg-2">
    <!-- label ‚Äúfantasma‚Äù para igualar altura de cabecera -->
    <label class="form-label small mb-1 d-none d-lg-block">&nbsp;</label>
    <div class="d-flex gap-2">
      <button id="uploadCsvBtn" type="submit" class="btn btn-primary w-100">Subir archivo</button>
      <a href="{{ url_for('static', filename='plantilla.csv') }}" class="btn btn-secondary w-100" download>
        Descargar plantilla
      </a>
    </div>
  </div>
</div>

<!-- Nota de ayuda (fuera de la fila para no desalinear) -->
<div class="row mb-3">
  <div class="col-12">
    <div class="form-text small">Solo archivos .csv o .txt con una IP por l√≠nea.</div>
  </div>
</div>
  </div>

  <div class="tab-pane fade" id="pane-delete" role="tabpanel" aria-labelledby="tab-delete">
    <!-- Acciones avanzadas -->
    <div class="row g-3 mb-4">
      <div class="col-lg-6">
        <button type="button" class="btn btn-outline-warning w-100" data-bs-toggle="modal" data-bs-target="#modalDeleteNet">
          Eliminar por patr√≥n (CIDR / Rango / IP+M√°scara / IP)
        </button>
      </div>
      <div class="col-lg-6">
        <div class="hint-box">
          <strong>Ejemplos v√°lidos:</strong>
          <ul class="mb-0">
            <li><code>203.0.113.0/24</code> (CIDR)</li>
            <li><code>203.0.113.10-203.0.113.50</code> (rango)</li>
            <li><code>203.0.113.0 255.255.255.0</code> (IP + m√°scara)</li>
            <li><code>203.0.113.5</code> (IP suelta)</li>
          </ul>
        </div>
      </div>
    </div>
  </form>
  </div>
</div>
 
  
  <!-- Modal Confirmaci√≥n Eliminar Todas -->
  <div class="modal fade" id="confirmDeleteAll" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <form method="POST">
          <div class="modal-header">
            <h5 class="modal-title text-danger">¬øEliminar todas las IPs?</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
          </div>
          <div class="modal-body">
            ¬øEst√°s seguro de que deseas eliminar <strong>todas</strong> las IPs bloqueadas?<br>
            Esta acci√≥n se podr√° <strong>deshacer durante 10 minutos</strong>.
          </div>
          <div class="modal-footer">
            <input type="hidden" name="delete-all" value="1">
            <button type="submit" class="btn btn-danger">Eliminar todas</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modal Eliminar por Patr√≥n (con previsualizaci√≥n) -->
  <div class="modal fade" id="modalDeleteNet" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <form method="POST" class="modal-content" onsubmit="return confirmDeletePattern();">
        <div class="modal-header">
          <h5 class="modal-title">Eliminar por patr√≥n</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <label for="delete_net_input" class="form-label">Introduce un patr√≥n:</label>
          <input type="text" class="form-control" id="delete_net_input" name="delete_net_input"
                 placeholder="Ej: 203.0.113.0/24 ¬∑ 203.0.113.10-203.0.113.50 ¬∑ 203.0.113.0 255.255.255.0 ¬∑ 203.0.113.5"
                 required>

          <!-- Resultado de previsualizaci√≥n -->
          <div id="previewResult" class="mt-2 small text-muted">
            Escribe un patr√≥n para ver cu√°ntas IPs coinciden.
          </div>

          <div class="hint-box mt-3">
            <strong>Se eliminar√°n todas las IPs que coincidan.</strong>
            <ul class="mb-0">
              <li>CIDR: <code>203.0.113.0/24</code></li>
              <li>Rango: <code>203.0.113.10-203.0.113.50</code></li>
              <li>IP + m√°scara: <code>203.0.113.0 255.255.255.0</code></li>
              <li>IP suelta: <code>203.0.113.5</code></li>
            </ul>
          </div>
        </div>
        <div class="modal-footer">
          <input type="hidden" name="delete-net" value="1">
          <button type="submit" class="btn btn-warning">Eliminar coincidencias</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <hr>
  <h4>IPs bloqueadas</h4>

  <!-- Controles server-side (progresivo; si falla JSON, queda fallback local) -->
  <div class="toolbar-grid mb-3" id="serverToolbar">
    <div>
      <label class="form-label small mb-1">Buscar IP</label>
      <input type="text" id="qInput" class="form-control" placeholder="Ej: 203.0.113.5">
    </div>
    <div class="d-flex gap-2">
      <div>
        <label class="form-label small mb-1">Desde</label>
        <input type="date" id="dateFrom" class="form-control">
      </div>
      <div>
        <label class="form-label small mb-1">Hasta</label>
        <input type="date" id="dateTo" class="form-control">
      </div>
    </div>
    <div>
      <label class="form-label small mb-1">Ordenar por</label>
      <select id="sortSelect" class="form-select">
        <option value="fecha" selected>Fecha alta</option>
        <option value="ttl">TTL (expiraci√≥n)</option>
        <option value="ip">IP</option>
      </select>
    </div>
    <div>
      <label class="form-label small mb-1">Orden</label><br>
      <div class="btn-group">
        <button id="orderDesc" class="btn btn-outline-secondary btn-sm active" type="button" data-order="desc">Desc</button>
        <button id="orderAsc" class="btn btn-outline-secondary btn-sm" type="button" data-order="asc">Asc</button>
      </div>
    </div>
    <div>
      <label class="form-label small mb-1">Tama√±o p√°g.</label>
      <select id="pageSize" class="form-select">
        <option>10</option>
        <option>25</option>
        <option selected>50</option>
        <option>100</option>
      </select>
    </div>
    <div class="d-flex align-items-end gap-2">
      <button id="applyTableFilters" class="btn btn-outline-primary">Aplicar</button>
      <button id="clearTableFilters" class="btn btn-outline-secondary">Limpiar</button>
    </div>
  </div>

  <!-- Buscador local (fallback) -->
  <div class="mb-3 d-none" id="localSearchWrap">
    <input type="text" id="buscadorIp" class="form-control" placeholder="Buscar IP...">
  </div>

  <div class="d-flex justify-content-between align-items-center mb-2">
    <div class="small text-muted">
      <span id="bulkSelectedCount">0</span> seleccionada(s)
    </div>
    <button id="bulkDeleteBtn" class="btn btn-outline-danger btn-sm" disabled>
      üóëÔ∏è Eliminar seleccionadas
    </button>
  </div>

  <div class="table-responsive">
    <table class="table table-striped table-hover" id="tablaIps">
      <thead>
        <tr>
          <th style="width:36px">
            <input type="checkbox" id="chkAll">
          </th>
          <th>IP</th>
          <th>Fecha</th>
          <th>TTL</th>
          <th>Tags</th>
          <th>Alertas</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody>
      {% if ips and ips|length > 0 %}
        {% for item in ips %}
          {% set parts = item.split('|') %}
          {% set ip_txt = parts[0].strip() %}
          {% set tags = (ip_tags.get(ip_txt, []) if ip_tags is defined and ip_tags else []) %}
          {% if ip_alerts is defined and ip_alerts %}
            {% set alerts = ip_alerts.get(ip_txt, []) %}
          {% else %}
            {% set alerts = [] %}
          {% endif %}
          <tr>
            <td>
              <input type="checkbox" class="row-chk" value="{{ ip_txt }}">
            </td>
            <td>{{ ip_txt }}</td>
            <td>{{ parts[1] }}</td>
            <td>{{ '‚àû' if parts[2] == '0' else parts[2] }}</td>
            <td>
              {% if tags %}
                {% for t in tags %}
                  <span class="badge" style="background-color: {{ tag_color(t) }}; color:#fff; margin-right:6px;">
                    {{ t }}
                  </span>
                {% endfor %}
              {% else %}
                <span class="text-muted">‚Äî</span>
              {% endif %}
            </td>
            <td>
              {% if alerts %}
                <span class="badge text-bg-info">
                  {{ alerts|length }} alerta{{ 's' if alerts|length != 1 else '' }}
                </span>
                <div class="alert-ids-list text-muted">
                  {{ alerts|join(', ') }}
                </div>
              {% else %}
                <span class="text-muted">‚Äî</span>
              {% endif %}
            </td>
            <td>
              <button class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#confirmDelete{{ loop.index }}">Eliminar</button>
              <div class="modal fade" id="confirmDelete{{ loop.index }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered">
                  <div class="modal-content">
                    <form method="POST">
                      <div class="modal-header">
                        <h5 class="modal-title">Confirmar eliminaci√≥n</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                      </div>
                      <div class="modal-body">
                        ¬øEliminar <strong>{{ ip_txt }}</strong>?
                      </div>
                      <div class="modal-footer">
                        <input type="hidden" name="delete_ip" value="{{ ip_txt }}">
                        <button type="submit" class="btn btn-danger">Eliminar</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        {% endfor %}
      {% else %}
        <tr>
          <td colspan="7" class="text-center text-muted">‚Äî</td>
        </tr>
      {% endif %}
      </tbody>
    </table>
  </div>

  <!-- Paginaci√≥n server-side -->
  <div class="d-flex align-items-center justify-content-between mt-2" id="pagerBar">
    <div class="small text-muted" id="pageInfo">P√°gina 1</div>
    <div class="btn-group">
      <button id="prevPage" class="btn btn-outline-secondary btn-sm">¬´</button>
      <button id="nextPage" class="btn btn-outline-secondary btn-sm">¬ª</button>
    </div>
  </div>

  <div class="text-center mt-4">
    <p class="text-muted">Proyecto hecho por Darell P√©rez ¬∑ Todos los derechos reservados</p>
  </div>
</div>

<!-- Logo DPB fijo (abajo derecha, SIN TOCAR) -->
<img id="corner-logo" src="{{ url_for('static', filename='img/logo-dpb.svg') }}" alt="Logo DPB">

<!-- Offcanvas de Notificaciones -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasNotifs" aria-labelledby="offcanvasNotifsLabel">
  <div class="offcanvas-header">
    <h5 id="offcanvasNotifsLabel">Notificaciones</h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Cerrar"></button>
  </div>
  <div class="offcanvas-body d-flex flex-column" style="gap:.75rem;">
    <!-- Filtros -->
    <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
      <select id="filterType" class="form-select form-select-sm" style="max-width:180px">
        <option value="">Todos los tipos</option>
        <option value="success">Altas correctas</option>
        <option value="warning">Eliminaciones</option>
        <option value="danger">Rechazadas/Errores</option>
        <option value="accion_no_permitida">Bloqueo global</option>
      </select>
      <input id="filterDate" type="date" class="form-control form-control-sm" style="max-width:180px">
      <button id="applyFilters" class="btn btn-outline-primary btn-sm">Aplicar</button>
      <button id="clearFilters" class="btn btn-outline-secondary btn-sm">Limpiar</button>
      <span class="ms-auto small text-muted" id="notifCountInfo"></span>
    </div>

    <!-- Lista -->
    <div id="notifList" class="d-flex flex-column" style="gap:.5rem;"></div>

    <!-- Paginaci√≥n (10 por p√°gina) -->
    <nav class="mt-2">
      <ul id="notifPagination" class="pagination pagination-sm mb-0"></ul>
    </nav>
  </div>
</div>

<!-- Portal de toasts -->
<div id="toast-portal" aria-live="polite" aria-atomic="true"></div>

<script>
  /* ----------------- Tema oscuro (√∫nica y persistente) ----------------- */
  window.toggleTheme = function () {
    const body = document.body;

    const isDark = !body.classList.contains('bg-dark');

    if (isDark) {
      body.classList.remove('bg-light');
      body.classList.add('bg-dark','text-white');
    } else {
      body.classList.remove('bg-dark','text-white');
      body.classList.add('bg-light');
    }

    document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');

    const anti = document.getElementById('anti-flash-dark');
    if (!isDark && anti) anti.remove();

    document.querySelectorAll('.card, .form-control, .form-select, .table').forEach(e => {
      e.classList.toggle('bg-dark', isDark);
      e.classList.toggle('text-white', isDark);
    });

    const tbl = document.getElementById('tablaIps');
    if (tbl) tbl.classList.toggle('table-dark', isDark);

    const notifBtn = document.getElementById('notif-btn');
    if (notifBtn) {
      notifBtn.classList.toggle('btn-primary', isDark);
      notifBtn.classList.toggle('btn-outline-primary', !isDark);
    }

    localStorage.setItem('theme', isDark ? 'dark' : 'light');
  };

  (function applySavedThemeEarly() {
    try {
      const saved = localStorage.getItem('theme');
      document.documentElement.setAttribute('data-theme', saved === 'dark' ? 'dark' : 'light');

      const onReady = () => {
        if (document.readyState === 'interactive' || document.readyState === 'complete') {
          document.removeEventListener('readystatechange', onReady);

          const body = document.body;
          if (saved === 'dark') {
            body.classList.remove('bg-light');
            body.classList.add('bg-dark','text-white');

            const tbl = document.getElementById('tablaIps');
            if (tbl && !tbl.classList.contains('table-dark')) {
              tbl.classList.add('table-dark');
            }

            const nb = document.getElementById('notif-btn');
            if (nb) { nb.classList.add('btn-primary'); nb.classList.remove('btn-outline-primary'); }
          } else {
            body.classList.remove('bg-dark','text-white');
            body.classList.add('bg-light');

            const nb = document.getElementById('notif-btn');
            if (nb) { nb.classList.add('btn-outline-primary'); nb.classList.remove('btn-primary'); }
          }
        }
      };

      if (document.readyState === 'interactive' || document.readyState === 'complete') onReady();
      else document.addEventListener('readystatechange', onReady);
    } catch {}
  })();

  /* ----------------- Estado de tabla (server-side) ----------------- */
  const state = {
    page: 1,
    page_size: 50,
    sort: 'fecha',
    order: 'desc',
    q: '',
    date_from: '',
    date_to: ''
  };
  let serverMode = true; // intentamos server JSON; si falla, fallback local

  /* ----------------- Buscador local (fallback) ----------------- */
  function initLocalSearchFallback(){
    const wrap = document.getElementById('localSearchWrap');
    wrap.classList.remove('d-none');
    const input = document.getElementById('buscadorIp');
    const table = document.getElementById('tablaIps');
    if (input && table) {
      input.addEventListener('keyup', function () {
        const filtro = input.value.toLowerCase();
        const filas = table.getElementsByTagName('tr');
        for (let i = 1; i < filas.length; i++) {
          const celdas = filas[i].getElementsByTagName('td');
          if (celdas.length > 1) {
            const ip = celdas[1].textContent.toLowerCase();
            filas[i].style.display = ip.includes(filtro) ? '' : 'none';
          }
        }
      });
    }
  }

  /* ----------------- Datos de notificaciones (inyectados) ----------------- */
  const serverMessages = [
    {% for category, message in (messages or []) %}
      {"category": "{{category}}", "message": {{ message|tojson }} }{% if not loop.last %},{% endif %}
    {% endfor %}
  ];
  window.serverMessages = serverMessages;

  /* --------------- Marcar tipo de acci√≥n (manual vs csv) --------------- */
  (function wireActionMarkers(){
    const mark = (type)=>{ try{
      sessionStorage.setItem('lastActionType', type);
      sessionStorage.setItem('lastActionTs', String(Date.now()));
    }catch{} };

    document.getElementById('addManualBtn')?.addEventListener('click', ()=>mark('manual'));
    document.getElementById('uploadCsvBtn')?.addEventListener('click', ()=>mark('csv'));

    document.getElementById('mainForm')?.addEventListener('submit', ()=>{
      const fileHasValue = !!document.querySelector('input[type="file"][name="file"]')?.value;
      if (!sessionStorage.getItem('lastActionType')) {
        mark(fileHasValue ? 'csv' : 'manual');
      }
    });
  })();

  /* ----------------- Helpers Tags (manual y csv) ----------------- */
  function selectedTags(cls){
    return Array.from(document.querySelectorAll('.' + cls + ':checked')).map(el => el.value);
  }
  function syncHiddenTags(){
    const man = selectedTags('tag-manual');
    const csv = selectedTags('tag-csv');
    const manInput = document.getElementById('tagsManualInput');
    const csvInput = document.getElementById('tagsCsvInput');
    if (manInput) manInput.value = man.join(',');
    if (csvInput) csvInput.value = csv.join(',');
  }
  document.querySelectorAll('.tag-manual, .tag-csv').forEach(el=>{
    el.addEventListener('change', syncHiddenTags);
  });

  function showManualTagError(show){
    const fb = document.getElementById('tagManualFeedback');
    const hidden = document.getElementById('tagsManualInput');
    if (!fb || !hidden) return;
    fb.style.display = show ? 'block' : 'none';
    hidden.classList.toggle('is-invalid', !!show);
  }

  function showCsvTagError(show){
    const fb = document.getElementById('tagCsvFeedback');
    const group = document.getElementById('tagCsvGroup');
    if (!fb || !group) return;
    fb.style.display = show ? 'block' : 'none';
    group.classList.toggle('is-invalid', !!show);
  }

  const setLoading = (btn, textWhileLoading) => {
    if (!btn) return;
    btn.dataset.originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = `
      <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
      <span class="ms-1">${textWhileLoading}</span>
    `;
  };

document.getElementById('mainForm')?.addEventListener('submit', (ev) => {
  // --- Validaci√≥n de tags ---
  syncHiddenTags();
  const fileHasValue = !!document.querySelector('input[type="file"][name="file"]')?.value;

  if (!fileHasValue) {            // === Flujo MANUAL ===
    const man = selectedTags('tag-manual');
    if (man.length === 0) {
      ev.preventDefault(); ev.stopPropagation();
      showManualTagError(true);
      document.querySelector('.tag-manual')?.focus();
      return;
    } else {
      showManualTagError(false);
    }
  } else {                        // === Flujo CSV (OBLIGATORIO) ===
    const csv = selectedTags('tag-csv');
    if (csv.length === 0) {
      ev.preventDefault(); ev.stopPropagation();
      showCsvTagError(true);
      document.querySelector('.tag-csv')?.focus();
      return;
    } else {
      showCsvTagError(false);
    }
  }

  // Spinners (igual que ten√≠as)
  const manualBtn = document.getElementById('addManualBtn');
  const csvBtn = document.getElementById('uploadCsvBtn');
  if (fileHasValue) {
    setLoading(csvBtn, 'Subiendo‚Ä¶');
  } else {
    setLoading(manualBtn, 'A√±adiendo‚Ä¶');
  }
});

  window.addEventListener('pageshow', () => {
    ['addManualBtn','uploadCsvBtn'].forEach(id => {
      const b = document.getElementById(id);
      if (b && b.dataset.originalHtml) {
        b.innerHTML = b.dataset.originalHtml;
        b.disabled = false;
        delete b.dataset.originalHtml;
      }
    });
  });

  /* ----------------- TOAST de la acci√≥n actual ----------------- */
  (function showCombinedActionToast(){
    try {
      const ACTION_PAST_TOL = 5000;
      const ACTION_FUT_TOL  = 90000;
      const lastActionTs = parseInt(sessionStorage.getItem('lastActionTs')||'0',10) || 0;
      const lastActionType = (sessionStorage.getItem('lastActionType')||'').toLowerCase();

      const norm = (s)=> (s||'').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g,'');
      const actionKeywords = [
        'anadida','anadidas','eliminada','eliminadas','eliminacion',
        'borrada','borradas','rechazada','rechazadas','accion no permitida',
        'ip duplicada','ip rechazada','nada que anadir','entradas rechazadas',
        'backup forzado creado','backup diario creado','patron','mascara'
      ];
      const normKeywords = actionKeywords.map(norm);
      const isActionable = (txt)=> normKeywords.some(k => norm(txt).includes(k));

      const startsWithDate = (txt)=> /^\d{4}-\d{2}-\d{2}/.test((txt||'').trim());
      const parseLeadingDateTs = (txt)=>{
        const m = (txt||'').match(/^(\d{4}-\d{2}-\d{2})(?:\s+(\d{2}:\d{2}:\d{2}))?\s+(.*)$/);
        if (!m) return null;
        const ymd = m[1], hms = m[2] || '00:00:00';
        const d = new Date(`${ymd}T${hms}`);
        return isNaN(d.getTime()) ? null : d.getTime();
      };

      function isFromCurrentAction(txt){
        if (!isActionable(txt)) return false;
        const ts = parseLeadingDateTs(txt);
        if (!lastActionTs) return !startsWithDate(txt);
        if (ts === null) return true;
        return (ts >= lastActionTs - ACTION_PAST_TOL) && (ts <= lastActionTs + ACTION_FUT_TOL);
      }

      const msgs = (window.serverMessages||[]).filter(m => isFromCurrentAction(m.message));
      if (!msgs.length) return;

      const byCat = { success: [], warning: [], danger: [], accion_no_permitida: [] };
      msgs.forEach(m=>{
        const k = (m.category==='accion_no_permitida') ? 'accion_no_permitida'
              : (m.category==='warning') ? 'warning'
              : (m.category==='success') ? 'success' : 'danger';
        byCat[k].push(m.message||'');
      });

      const uniq = (arr)=> Array.from(new Set(arr));
      const extractIPs = (texts)=>{
        const ipRe = /\b(?:25[0-5]|2[0-4]\d|1?\d?\d)(?:\.(?:25[0-5]|2[0-4]\d|1?\d?\d)){3}\b/g;
        const out=[]; texts.forEach(t=> (t.match(ipRe)||[]).forEach(ip=> out.push(ip)));
        return uniq(out);
      };
      const listPreview = (arr,n=6)=> arr.length<=n ? arr.join(', ') : `${arr.slice(0,n).join(', ')} ‚Ä¶ (+${arr.length-n})`;
      const stripDatePrefix = (txt) => (txt||'').replace(/^(\d{4}-\d{2}-\d{2})(?:\s+\d{2}:\d{2}:\d{2})?\s+/, '');

      let parts = [];

      if (byCat.success.length){
        if (lastActionType === 'manual'){
          const ips = extractIPs(byCat.success);
          if (ips.length === 1) parts.push(`IP a√±adida: ${ips[0]}`);
          else if (ips.length > 1) parts.push(`${ips.length} IP(s) a√±adida(s): ${listPreview(ips, 6)}`);
          else parts.push(`${byCat.success.length} operaci√≥n(es) correcta(s)`);
        } else {
          const nums = byCat.success.map(t => { const m=t.match(/(^|\s)(\d+)\s/); return m?parseInt(m[2],10):null; }).filter(x=>x!==null);
          const total = nums.length===byCat.success.length ? nums.reduce((a,b)=>a+b,0) : byCat.success.length;
          parts.push(`${total} IP(s) a√±adida(s)`);
        }
      }

      if (byCat.warning.length){
        if (lastActionType === 'manual'){
          const ips = extractIPs(byCat.warning);
          if (ips.length === 1) parts.push(`IP eliminada: ${ips[0]}`);
          else if (ips.length > 1) parts.push(`${ips.length} IP(s) eliminada(s): ${listPreview(ips, 6)}`);
          else parts.push(`${byCat.warning.length} IP(s) eliminada(s)`);
        } else {
          const nums = byCat.warning.map(t => { const m=t.match(/(^|\s)(\d+)\s/); return m?parseInt(m[2],10):null; }).filter(x=>x!==null);
          const total = nums.length===byCat.warning.length ? nums.reduce((a,b)=>a+b,0) : byCat.warning.length;
          parts.push(`${total} IP(s) eliminada(s)`);
        }
      }

      if (byCat.danger.length) {
        const reasonRaw = stripDatePrefix(byCat.danger[0] || '');
        const reason = reasonRaw.replace(/\s+/g,' ').trim();
        const shown = reason.length > 140 ? reason.slice(0,140) + '‚Ä¶' : reason;
        parts.push(`Entradas rechazadas: ${shown}`);
      }
      if (byCat.accion_no_permitida.length) {
        const reasonRaw = stripDatePrefix(byCat.accion_no_permitida[0] || '');
        const reason = reasonRaw.replace(/\s+/g,' ').trim();
        parts.push(reason ? `Acci√≥n no permitida: ${reason}` : 'Acci√≥n no permitida');
      }

      const combinedText = parts.join(' ‚Äî ');
      if (!combinedText) return;

      const badge = document.getElementById('notif-badge');
      const getUnread = ()=> parseInt(localStorage.getItem('notif_unread')||'0',10);
      const setUnread = (v)=> localStorage.setItem('notif_unread', String(Math.max(0, v|0)));
      setUnread(getUnread()+1);
      if (badge){ const t=getUnread(); badge.textContent=t; badge.classList.toggle('d-none', t<=0); }

      const color = (byCat.accion_no_permitida.length || byCat.danger.length) ? 'danger'
                   : (byCat.warning.length ? 'warning' : 'success');
      const delay = (color==='danger') ? 20000 : 10000;

      const portal = document.getElementById('toast-portal');
      const el = document.createElement('div');
      el.className = 'toast align-items-center text-bg-' + color + ' border-0';
      el.innerHTML = `
        <div class="d-flex align-items-center">
          <div class="toast-body">${escapeHtml(combinedText)}</div>
          <div class="d-flex align-items-center gap-2 me-2">
            <button type="button" class="btn btn-light btn-sm" id="undoBtn">Deshacer</button>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>`;
      portal.appendChild(el);
      new bootstrap.Toast(el, { autohide: true, delay }).show();

      el.querySelector('#undoBtn')?.addEventListener('click', async () => {
        try{
          const r = await fetch('/undo-last', { method:'POST' });
          const data = await r.json();
          showInlineToast(data?.ok ? 'warning' : 'danger', data?.ok ? (data?.notices?.[0]?.message || 'Acci√≥n deshecha') : (data?.error || 'No se pudo deshacer'));
          if (typeof reloadTable === 'function') await reloadTable();
        }catch(e){
          showInlineToast('danger','Error al deshacer');
        }
      });

      try { sessionStorage.removeItem('lastActionTs'); sessionStorage.removeItem('lastActionType'); } catch {}
    } catch (err) {
      console.error('showCombinedActionToast error:', err);
    }
  })();

  function showInlineToast(kind, text, delay=6000){
    const portal = document.getElementById('toast-portal');
    const el = document.createElement('div');
    el.className = 'toast align-items-center text-bg-' + mapToastColor(kind) + ' border-0';
    el.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">${escapeHtml(text||'')}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto"
                data-bs-dismiss="toast" aria-label="Close"></button>
      </div>`;
    portal.appendChild(el);
    new bootstrap.Toast(el, { autohide: true, delay }).show();
  }

  document.getElementById('markReadBtn').addEventListener('click', async () => {
    try { await fetch('/notifications/read-all', { method:'POST' }); } catch (e) {}
    markAllReadUI();
    showInlineToast('success','Notificaciones marcadas como le√≠das');
  });
  const offcanvasEl = document.getElementById('offcanvasNotifs');
  if (offcanvasEl) {
    offcanvasEl.addEventListener('shown.bs.offcanvas', async () => {
      try { await fetch('/notifications/read-all', { method:'POST' }); } catch (e) {}
      markAllReadUI();
    });
  }

  const PAGE_SIZE_NOTIF = 10;

  let notifData = (serverMessages || []).map((m, i) => {
    const txt = m.message || '';
    const theMatch = txt.match(/^(\d{4}-\d{2}-\d{2})(?:\s+(\d{2}:\d{2}:\d{2}))?\s+(.*)$/);
    let dt = null;
    let cleanMsg = txt;
    if (theMatch) {
      const ymd = theMatch[1];
      const hms = theMatch[2] || '00:00:00';
      dt = new Date(`${ymd}T${hms}`);
      cleanMsg = theMatch[3];
    }
    return { id: i+1, category: m.category, message: cleanMsg, date: dt };
  });

  notifData.sort((a, b) => {
    const ad = a.date ? a.date.getTime() : -Infinity;
    const bd = b.date ? b.date.getTime() : -Infinity;
    return bd - ad;
  });

  const listEl = document.getElementById('notifList');
  const pagEl = document.getElementById('notifPagination');
  const infoEl = document.getElementById('notifCountInfo');

  let filterType = '';
  let filterDate = '';
  let currentPage = 1;

  document.getElementById('applyFilters').addEventListener('click', () => {
    filterType = document.getElementById('filterType').value;
    filterDate = document.getElementById('filterDate').value;
    currentPage = 1;
    renderList();
  });
  document.getElementById('clearFilters').addEventListener('click', () => {
    document.getElementById('filterType').value = '';
    document.getElementById('filterDate').value = '';
    filterType = filterDate = '';
    currentPage = 1;
    renderList();
  });

  function filtered() {
    return notifData.filter(n => {
      if (filterType && n.category !== filterType) return false;
      if (filterDate) {
        const d = n.date;
        if (!d) return false;
        const ymd = d.toISOString().slice(0,10);
        if (ymd !== filterDate) return false;
      }
      return true;
    });
  }

  function renderList() {
    const data = filtered();
    const totalPages = Math.max(1, Math.ceil(data.length / PAGE_SIZE_NOTIF));
    if (currentPage > totalPages) currentPage = totalPages;

    const start = (currentPage - 1) * PAGE_SIZE_NOTIF;
    const pageItems = data.slice(start, start + PAGE_SIZE_NOTIF);

    infoEl.textContent = `Mostrando ${pageItems.length} de ${data.length} notificaciones`;

    listEl.innerHTML = '';
    pageItems.forEach(n => {
      const cls = mapToastColor(n.category);
      const pill = n.category === 'success' ? '‚úÖ' :
                   n.category === 'warning' ? '‚ö†Ô∏è' :
                   (n.category === 'danger' || n.category === 'accion_no_permitida') ? '‚ùå' : '‚ÑπÔ∏è';
      const dtTxt = n.date ? n.date.toLocaleString() : '';
      const item = document.createElement('div');
      item.className = `border rounded p-2 bg-white`;
      item.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
          <span class="badge text-bg-${cls}">${pill}</span>
          <span class="small text-muted ms-2">${escapeHtml(dtTxt)}</span>
        </div>
        <div class="mt-1">${escapeHtml(n.message)}</div>
      `;
      listEl.appendChild(item);
    });

    pagEl.innerHTML = '';
    const mkPage = (p, label = p, disabled = false, active = false) => {
      const li = document.createElement('li');
      li.className = `page-item ${disabled ? 'disabled' : ''} ${active ? 'active' : ''}`;
      const a = document.createElement('a');
      a.className = 'page-link';
      a.href = '#';
      a.textContent = label;
      a.addEventListener('click', (e) => {
        e.preventDefault();
        if (!disabled && currentPage !== p) {
          currentPage = p;
          renderList();
        }
      });
      li.appendChild(a);
      return li;
    };
    const pages = Math.max(1, Math.ceil(data.length / PAGE_SIZE_NOTIF));
    pagEl.appendChild(mkPage(Math.max(1, currentPage-1), '¬´', currentPage === 1, false));
    for (let p = 1; p <= pages; p++) pagEl.appendChild(mkPage(p, String(p), false, p === currentPage));
    pagEl.appendChild(mkPage(Math.min(pages, currentPage+1), '¬ª', currentPage >= pages, false));
  }
  renderList();

  (function initDeletePreview() {
    const input = document.getElementById('delete_net_input');
    const preview = document.getElementById('previewResult');
    if (!input || !preview) return;

    let lastController = null;

    input.addEventListener('input', () => {
      const val = input.value.trim();
      if (!val) {
        preview.textContent = "Escribe un patr√≥n para ver cu√°ntas IPs coinciden.";
        preview.className = 'mt-2 small text-muted';
        return;
      }

      if (lastController) lastController.abort();
      lastController = new AbortController();

      fetch(`/preview-delete?pattern=${encodeURIComponent(val)}`, { signal: lastController.signal })
        .then(r => r.json())
        .then(data => {
          if (data.error) {
            preview.textContent = `‚ùå ${data.error}`;
            preview.className = 'mt-2 small text-danger';
          } else {
            preview.textContent = `Coinciden ${data.count} IP(s).`;
            preview.className = 'mt-2 small text-success';
          }
        })
        .catch(err => {
          if (err.name === 'AbortError') return;
          preview.textContent = "‚ùå Error al consultar coincidencias.";
          preview.className = 'mt-2 small text-danger';
        });
    });
  })();

  (function initInstantValidate(){
    const input = document.getElementById('ipInput');
    const feedback = document.getElementById('ipFeedback');
    const form = document.getElementById('mainForm');

    if(!input || !feedback || !form) return;

    const OCTET = '(25[0-5]|2[0-4]\\d|1?\\d?\\d)';
    const ipv4Re   = new RegExp(`^${OCTET}(\\.${OCTET}){3}$`);
    const cidrRe   = new RegExp(`^${OCTET}(\\.${OCTET}){3}\\/(?:[0-9]|[12][0-9]|3[0-2])$`);
    const rangeRe  = new RegExp(`^${OCTET}(\\.${OCTET}){3}\\s*-\\s*${OCTET}(\\.${OCTET}){3}$`);
    const ipMaskRe = new RegExp(`^${OCTET}(\\.${OCTET}){3}\\s+${OCTET}(\\.${OCTET}){3}$`);

    const validMasks = new Set([
      '255.255.255.255','255.255.255.254','255.255.255.252','255.255.255.248',
      '255.255.255.240','255.255.255.224','255.255.255.192','255.255.255.128',
      '255.255.255.0','255.255.254.0','255.255.252.0','255.255.248.0',
      '255.255.240.0','255.255.224.0','255.255.192.0','255.255.128.0',
      '255.255.0.0','255.254.0.0','255.252.0.0','255.248.0.0','255.240.0.0',
      '255.224.0.0','255.192.0.0','255.128.0.0','255.0.0.0',
      '254.0.0.0','252.0.0.0','248.0.0.0','240.0.0.0','224.0.0.0',
      '192.0.0.0','128.0.0.0','0.0.0.0'
    ]);

    function isForbiddenZero(val){
      const v = val.trim();
      if (v === '0.0.0.0') return true;
      if (v.startsWith('0.0.0.0/')) return true;
      if (v.startsWith('0.0.0.0 ')) return true;
      if (/^\s*0\.0\.0\.0\s*-\s*/.test(v)) return true;
      return false;
    }

    function validate(val){
      if(!val || !val.trim()){
        return { ok:false, msg:'Introduce una IP, CIDR, rango o IP con m√°scara.' };
      }
      if(isForbiddenZero(val)) {
        return { ok:false, msg:'Acci√≥n no permitida: bloqueo de absolutamente todo (0.0.0.0).' };
      }
      if (ipv4Re.test(val)) return { ok:true };
      if (cidrRe.test(val)) return { ok:true };
      if (rangeRe.test(val)) return { ok:true };
      if (ipMaskRe.test(val)) {
        const mask = val.trim().split(/\s+/)[1];
        if (validMasks.has(mask)) return { ok:true };
        return { ok:false, msg:'M√°scara inv√°lida. Usa m√°scara de red contigua (p.ej. 255.255.255.0).' };
      }
      return { ok:false, msg:'Formato inv√°lido. Ejemplos: 1.2.3.4 ¬∑ 1.2.3.0/24 ¬∑ 1.2.3.4-1.2.3.20 ¬∑ 1.2.3.0 255.255.255.0' };
    }

    function setState(state){
      if(state.ok){
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        feedback.textContent = '';
      }else{
        input.classList.remove('is-valid');
        input.classList.add('is-invalid');
        feedback.textContent = state.msg || 'Formato inv√°lido';
      }
    }

    input.addEventListener('input', () => {
      const state = validate(input.value);
      if(!input.value.trim()){
        input.classList.remove('is-valid','is-invalid');
        feedback.textContent = '';
        return;
      }
      setState(state);
    });

    form.addEventListener('submit', (e) => {
      if (input.value.trim()){
        const state = validate(input.value);
        if(!state.ok){
          e.preventDefault();
          e.stopPropagation();
          setState(state);
          input.focus();
        }
      }
    });
  })();

  function mapToastColor(cat) {
    if (cat === 'success') return 'success';
    if (cat === 'warning') return 'warning';
    if (cat === 'accion_no_permitida' || cat === 'danger') return 'danger';
    return 'secondary';
  }
  function escapeHtml(str) {
    return (str || '').replace(/[&<>\"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
  }

  function confirmDeletePattern() {
    const val = document.getElementById('delete_net_input').value.trim();
    return confirm(`Vas a eliminar todas las IPs que coincidan con:\n\n${val}\n\n¬øConfirmas?`);
  }
  function markAllReadUI(){
    localStorage.setItem('notif_unread','0');
    const badge = document.getElementById('notif-badge');
    if (badge){
      badge.textContent = '0';
      badge.classList.add('d-none');
    }
  }

  function getSelectedIPs(){
    return Array.from(document.querySelectorAll('.row-chk:checked')).map(chk => chk.value);
  }

  function updateBulkUI(){
    const count = getSelectedIPs().length;
    const btn = document.getElementById('bulkDeleteBtn');
    const label = document.getElementById('bulkSelectedCount');
    if (label) label.textContent = String(count);
    if (btn) btn.disabled = (count === 0);
  }

  function attachTableSelectionHandlers(){
    document.querySelectorAll('.row-chk').forEach(chk => {
      chk.addEventListener('change', () => {
        updateBulkUI();
        const tr = chk.closest('tr');
        if (tr) tr.classList.toggle('table-active-selected', !!chk.checked);
      });
    });

    const master = document.getElementById('chkAll');
    if (master){
      master.checked = false;
      master.addEventListener('change', () => {
        const rows = document.querySelectorAll('.row-chk');
        rows.forEach(chk => {
          chk.checked = master.checked;
          const tr = chk.closest('tr');
          if (tr) tr.classList.toggle('table-active-selected', !!chk.checked);
        });
        updateBulkUI();
      });
    }

    updateBulkUI();
  } 

  const tbody = document.querySelector('#tablaIps tbody');
  const pageInfo = document.getElementById('pageInfo');
  const prevBtn = document.getElementById('prevPage');
  const nextBtn = document.getElementById('nextPage');

  const qInput = document.getElementById('qInput');
  const dateFrom = document.getElementById('dateFrom');
  const dateTo = document.getElementById('dateTo');
  const sortSelect = document.getElementById('sortSelect');
  const orderDesc = document.getElementById('orderDesc');
  const orderAsc  = document.getElementById('orderAsc');
  const pageSizeSel = document.getElementById('pageSize');
  const applyBtn = document.getElementById('applyTableFilters');
  const clearBtn = document.getElementById('clearTableFilters');

  orderDesc.addEventListener('click', () => { state.order='desc'; orderDesc.classList.add('active'); orderAsc.classList.remove('active'); reloadTable(true); });
  orderAsc .addEventListener('click', () => { state.order='asc';  orderAsc.classList.add('active');  orderDesc.classList.remove('active'); reloadTable(true); });
  sortSelect.addEventListener('change', () => { state.sort = sortSelect.value; reloadTable(true); });
  pageSizeSel.addEventListener('change', () => { state.page_size = parseInt(pageSizeSel.value,10)||50; state.page = 1; reloadTable(true); });

  applyBtn.addEventListener('click', () => {
    state.q = qInput.value.trim();
    state.date_from = dateFrom.value || '';
    state.date_to = dateTo.value || '';
    state.page = 1;
    reloadTable(true);
  });

  clearBtn.addEventListener('click', () => {
    qInput.value = ''; dateFrom.value=''; dateTo.value='';
    sortSelect.value='fecha'; state.sort='fecha';
    state.order='desc'; orderDesc.classList.add('active'); orderAsc.classList.remove('active');
    pageSizeSel.value = '50'; state.page_size=50; state.page=1;
    reloadTable(true);
  });

  prevBtn.addEventListener('click', () => { if (state.page>1){ state.page--; reloadTable(false);} });
  nextBtn.addEventListener('click', () => { state.page++; reloadTable(false); });

  async function reloadTable(resetIfEmpty){
    try{
      const params = new URLSearchParams();
      params.set('format','json');
      params.set('page', String(state.page));
      params.set('page_size', String(state.page_size));
      params.set('sort', state.sort);
      params.set('order', state.order);
      if (state.q) params.set('q', state.q);
      const hasRange = (state.date_from || state.date_to);
      if (hasRange){
        const val = `${state.date_from||''}${state.date_from||state.date_to ? ',' : ''}${state.date_to||''}`;
        params.set('date', val);
      }
      const r = await fetch(`/?${params.toString()}`, { headers: { 'Accept':'application/json' } });
      if (!r.ok) throw new Error('HTTP '+r.status);
      const data = await r.json();
      renderRows(data.items || []);
      updateCounters(data.counters);
      updatePager(data.page, data.page_size, data.total);
      serverMode = true;
      document.getElementById('localSearchWrap').classList.add('d-none');
    }catch(e){
      serverMode = false;
      initLocalSearchFallback();
    }
  }

  function tagBadge(t){
    // Colores simples por tipo de tag
    const cls = (t === 'BPE') ? 'text-bg-warning' : (t === 'Test' ? 'text-bg-secondary' : 'text-bg-primary');
    return `<span class="badge ${cls}" style="margin-right:6px;">${escapeHtml(t)}</span>`;
  }

  function alertsCellHtml(row){
    const ids = row.alert_ids || [];
    if (!ids.length){
      return '<span class="text-muted">‚Äî</span>';
    }
    const count = ids.length;
    const listPreview = ids.slice(0, 6).map(escapeHtml).join(', ');
    const more = ids.length > 6 ? ' ‚Ä¶' : '';
    const plural = count === 1 ? '' : 's';
    return `
      <span class="badge text-bg-info">${count} alerta${plural}</span>
      <div class="alert-ids-list text-muted">${listPreview}${more}</div>
    `;
  }

  function renderRows(items){
    tbody.innerHTML = '';
    items.forEach((row) => {
      const tr = document.createElement('tr');
      const ttlText = (row.ttl === 0 || row.ttl === '0') ? '‚àû' : String(row.ttl);
      tr.innerHTML = `
        <td><input type="checkbox" class="row-chk" value="${escapeHtml(row.ip)}"></td>
        <td>${escapeHtml(row.ip)}</td>
        <td>${escapeHtml(row.fecha_alta || '')}</td>
        <td>${escapeHtml(ttlText)}</td>
        <td>${
          (row.tags && row.tags.length)
            ? row.tags.map(tagBadge).join(' ')
            : '<span class="text-muted">‚Äî</span>'
        }</td>
        <td>${alertsCellHtml(row)}</td>
        <td>
          <form method="POST" onsubmit="return confirm('¬øEliminar ${escapeHtml(row.ip)}?');">
            <input type="hidden" name="delete_ip" value="${escapeHtml(row.ip)}">
            <button type="submit" class="btn btn-sm btn-outline-danger">Eliminar</button>
          </form>
        </td>
      `;
      tbody.appendChild(tr);
    });
    attachTableSelectionHandlers();
  }
  
  function updatePager(page, pageSize, total){
    const pages = Math.max(1, Math.ceil((total||0) / (pageSize||50)));
    state.page = Math.min(Math.max(1, parseInt(page||1,10)), pages);
    pageInfo.textContent = `P√°gina ${state.page} de ${pages} ‚Äî ${total||0} IPs`;
    prevBtn.disabled = (state.page <= 1);
    nextBtn.disabled = (state.page >= pages);
  }

  // ===>> Actualiza totales globales (incluye API y Tags)
  function updateCounters(counters){
    if (!counters) return;
    const t = document.getElementById('totalCount');
    const m = document.getElementById('manualCount');
    const c = document.getElementById('csvCount');
    const a = document.getElementById('apiCount');
    const tm = document.getElementById('tagMultiCount');
    const tb = document.getElementById('tagBpeCount');

    if (t && counters.total !== undefined) t.textContent = counters.total;
    if (m && counters.manual !== undefined) m.textContent = counters.manual;
    if (c && counters.csv !== undefined)    c.textContent = counters.csv;
    if (a && counters.api !== undefined)    a.textContent = counters.api;

    const tags = (counters.tags || {});
    if (tm && tags['Multicliente'] !== undefined) tm.textContent = tags['Multicliente'];
    if (tb && tags['BPE'] !== undefined)          tb.textContent = tags['BPE'];
  }

  async function bulkDeleteSelected(){
    const ips = getSelectedIPs();
    if (ips.length === 0) return;

    const preview = ips.slice(0,10).join(', ') + (ips.length > 10 ? ` ‚Ä¶ (+${ips.length-10})` : '');
    const ok = confirm(`Vas a eliminar ${ips.length} IP(s):\n\n${preview}\n\n¬øConfirmas?`);
    if (!ok) return;

    const btn = document.getElementById('bulkDeleteBtn');
    const origHtml = btn?.innerHTML;
    if (btn){
      btn.disabled = true;
      btn.innerHTML = `
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        <span class="ms-1">Eliminando‚Ä¶</span>`;
    }

    let okCount = 0, failCount = 0;

    for (const ip of ips){
      try{
        const fd = new FormData();
        fd.append('delete_ip', ip);
        const r = await fetch('/', { method:'POST', body: fd });
        if (r.ok) okCount++; else failCount++;
      }catch(e){
        failCount++;
      }
    }

    if (okCount && !failCount) {
      showInlineToast('warning', `${okCount} IP(s) eliminada(s).`);
    } else if (okCount && failCount) {
      showInlineToast('warning', `${okCount} eliminada(s) ¬∑ ${failCount} error(es).`);
    } else {
      showInlineToast('danger', 'No se pudo eliminar ninguna IP.');
    }

    document.getElementById('chkAll')?.click(); 
    updateBulkUI();

    if (typeof reloadTable === 'function') {
      await reloadTable(true);
    } else {
      const rows = Array.from(document.querySelectorAll('#tablaIps tbody tr'));
      ips.forEach(ip => {
        const row = rows.find(tr => tr.cells[1] && tr.cells[1].textContent.trim() === ip);
        if (row) row.remove();
      });
    }

    if (btn && origHtml){
      btn.innerHTML = origHtml;
      btn.disabled = false;
    }
  }
  document.getElementById('bulkDeleteBtn')?.addEventListener('click', bulkDeleteSelected);

  reloadTable(true);
  attachTableSelectionHandlers();

</script>

  <script>
document.addEventListener("DOMContentLoaded", function() {
  const checkboxes = document.querySelectorAll(".tag-manual");
  const hiddenInput = document.getElementById("tagsManualInput");

  function updateTagsManual() {
    const selected = Array.from(checkboxes)
      .filter(chk => chk.checked)
      .map(chk => chk.value);
    hiddenInput.value = selected.join(","); // ejemplo: "Multicliente,BPE"
  }

  checkboxes.forEach(chk => chk.addEventListener("change", updateTagsManual));
});
</script>
  
</body>
</html>
