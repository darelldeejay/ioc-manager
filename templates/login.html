<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Login - IOC Manager</title>
  <link rel="icon" href="{{ url_for('static', filename='img/logo-dpb.svg') }}?v=5">
  <link rel="shortcut icon" href="{{ url_for('static', filename='img/logo-dpb.svg') }}?v=5">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='img/logo-dpb.svg') }}?v=5">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap 3.4.1 (Glyphicons y tooltips con jQuery) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css">

  <!-- Estilos del login 3D -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/login.css') }}">
</head>

<body>

  <div id="wrapper">
    <div id="boxy-login-wrapper">

      <!-- Mensajes flash de Flask -->
      {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
      {% for category, message in messages %}
      <div class="alert alert-{{ category }} w-100 text-center mt-2">{{ message }}</div>
      {% endfor %}
      {% endif %}
      {% endwith %}

      <!-- 游댒 Alerta cliente (se muestra/oculta desde JS) -->
      <div id="login-alert" class="alert alert-danger text-center" role="alert" style="display:none;"></div>

      <form id="boxy-login-form" name="boxy-login-form" method="POST" action="{{ url_for('login') }}">
        <fieldset>
          <div class="boxy-form-inner rotateFirst3d">

            <!-- Tapa izquierda -->
            <span class="end-cap left">
              <span class="glyphicon glyphicon-user" data-toggle="tooltip" title="Haz click y Entra en mi Mundo"></span>
            </span>

            <!-- Usuario -->
            <span class="side front">
              <span class="glyphicon glyphicon-user" data-toggle="tooltip" title="usuario"></span>
              <input id="boxy-input" type="text" name="username" class="rotate" placeholder="Usuario" required>
              <!-- IMPORTANTE: que NO env칤e el form -->
              <button type="button" class="boxy-button next-field" data-step="0"></button>
            </span>

            <!-- Contrase침a -->
            <span class="side bottom">
              <span class="glyphicon glyphicon-asterisk" data-toggle="tooltip" title="contrase침a"></span>
              <input id="boxy-password" type="password" name="password" class="rotate" placeholder="Contrase침a"
                required>
              <button type="submit" class="boxy-button boxy-final-button" data-step="1"></button>
            </span>

            <!-- Tapa derecha decorativa -->
            <span class="end-cap right">
              <span class="glyphicon glyphicon-user"></span>
            </span>

          </div>
        </fieldset>
      </form>

    </div>
  </div>

  <img id="r8-logo-coin" src="{{ url_for('static', filename='img/logo-dpb.svg') }}" alt="Logo DPB">

  <!-- jQuery + Bootstrap 3 -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js"></script>

  <!-- Parche m칤nimo de robustez (no altera tu 3D) -->
  <script>
    (function () {
      // Tooltips
      $(function () { $('[data-toggle="tooltip"]').tooltip(); });

      // Enter en contrase침a => submit
      $('#boxy-password').on('keydown', function (e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          const form = document.getElementById('boxy-login-form');
          if (form && !form.dataset.submitted) {
            form.dataset.submitted = '1';
            form.submit();
          }
        }
      });

      // Si alg칰n script intercepta el click del bot칩n final, forzamos submit
      $('.boxy-final-button').on('click', function () {
        const form = document.getElementById('boxy-login-form');
        setTimeout(function () {
          if (form && !form.dataset.submitted) {
            form.dataset.submitted = '1';
            form.submit();
          }
        }, 50);
      });

      // Evitar doble env칤o
      $('#boxy-login-form').on('submit', function () {
        const form = this;
        if (form.dataset.submitted) { return; }
        form.dataset.submitted = '1';
      });
    })();
  </script>

  <!-- L칩gica 3D original -->
  <script src="{{ url_for('static', filename='js/login.js') }}"></script>

</body>

</html>